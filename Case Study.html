<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Case_Study</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="Case Study_files/libs/clipboard/clipboard.min.js"></script>
<script src="Case Study_files/libs/quarto-html/quarto.js"></script>
<script src="Case Study_files/libs/quarto-html/popper.min.js"></script>
<script src="Case Study_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Case Study_files/libs/quarto-html/anchor.min.js"></script>
<link href="Case Study_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Case Study_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Case Study_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Case Study_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Case Study_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Case_Study</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="setup-and-data-loading" class="level2">
<h2 class="anchored" data-anchor-id="setup-and-data-loading">1. Setup and Data Loading</h2>
<p>First, we load all the necessary R packages for data manipulation, modeling, and visualization. We also set some global options for the code chunks.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load necessary libraries</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)    <span class="co"># For data manipulation and visualization</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(moments)      <span class="co"># For moment calculations</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(car)          <span class="co"># For VIF calculation in linear models</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mgcv)         <span class="co"># For Generalized Additive Models (GAMs)</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(randomForest) <span class="co"># For Random Forest models</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kernlab)      <span class="co"># For Gaussian Process models</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)        <span class="co"># For creating well-formatted tables</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tibble)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ranger)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gratia)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Set global options for code chunks</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(<span class="at">echo =</span> <span class="cn">TRUE</span>, <span class="at">message =</span> <span class="cn">FALSE</span>, <span class="at">warning =</span> <span class="cn">FALSE</span>, <span class="at">fig.width =</span> <span class="dv">10</span>, <span class="at">fig.height =</span> <span class="dv">6</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="load-raw-data" class="level3">
<h3 class="anchored" data-anchor-id="load-raw-data">1.1. Load Raw Data</h3>
<p>We load the training and test datasets provided for the case study. [1, 1]</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the training and test data</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>train_raw <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data-train.csv"</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>test_raw <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data-test.csv"</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the first few rows of the training data</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(train_raw)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    St  Re    Fr R_moment_1 R_moment_2 R_moment_3 R_moment_4
1 0.10 224 0.052 0.00215700  0.1303500   14.37400  1586.5000
2 3.00 224 0.052 0.00379030  0.4704200   69.94000 10404.0000
3 0.70 224   Inf 0.00290540  0.0434990    0.82200    15.5510
4 0.05  90   Inf 0.06352800  0.0906530    0.46746     3.2696
5 0.70 398   Inf 0.00036945  0.0062242    0.12649     2.5714
6 2.00  90 0.300 0.14780000  2.0068000   36.24900   671.6700</code></pre>
</div>
</div>
</section>
</section>
<section id="data-preparation-and-feature-engineering" class="level2">
<h2 class="anchored" data-anchor-id="data-preparation-and-feature-engineering">2. Data Preparation and Feature Engineering</h2>
<p>This section covers the transformation of the raw simulation output into a format suitable for modeling.</p>
<section id="moment-conversion" class="level3">
<h3 class="anchored" data-anchor-id="moment-conversion">2.1. Moment Conversion</h3>
<p>The raw data provides the first four raw moments of the particle cluster volume distribution. We need to convert these into the more interpretable summary statistics: mean, standard deviation, skewness, and kurtosis. We create a function to handle this conversion.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="do">## ---- moment-conversion-fixed, message=FALSE, warning=FALSE -------------------</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Safer conversion of raw moments → mean, sd, skewness, kurtosis</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>calculate_summary_stats <span class="ot">&lt;-</span> <span class="cf">function</span>(raw_df, <span class="at">eps =</span> <span class="fl">1e-8</span>, <span class="at">return_flags =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check for required columns</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  required_cols <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"R_moment_1"</span>, <span class="st">"R_moment_2"</span>, <span class="st">"R_moment_3"</span>, <span class="st">"R_moment_4"</span>)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">all</span>(required_cols <span class="sc">%in%</span> <span class="fu">names</span>(raw_df))) {</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Input must contain columns: R_moment_1–R_moment_4"</span>)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(raw_df)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Build raw moment matrix (rows = moment order)</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  raw_mat <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rep</span>(<span class="dv">1</span>, n),              <span class="co"># 0th raw moment</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    raw_df<span class="sc">$</span>R_moment_1,      <span class="co"># 1st</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    raw_df<span class="sc">$</span>R_moment_2,      <span class="co"># 2nd</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    raw_df<span class="sc">$</span>R_moment_3,      <span class="co"># 3rd</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    raw_df<span class="sc">$</span>R_moment_4       <span class="co"># 4th</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert to central moments</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>  central_mat <span class="ot">&lt;-</span> <span class="fu">raw2central</span>(raw_mat)</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract central moments</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>  mu   <span class="ot">&lt;-</span> raw_df<span class="sc">$</span>R_moment_1</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>  mu2  <span class="ot">&lt;-</span> central_mat[<span class="dv">3</span>, ]  <span class="co"># variance</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>  mu3  <span class="ot">&lt;-</span> central_mat[<span class="dv">4</span>, ]</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>  mu4  <span class="ot">&lt;-</span> central_mat[<span class="dv">5</span>, ]</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Clean numerical artifacts</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>  mu2_clean <span class="ot">&lt;-</span> <span class="fu">pmax</span>(mu2, <span class="dv">0</span>)</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>  sigma     <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(mu2_clean)</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>  sigma_safe <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(sigma <span class="sc">&lt;</span> eps, <span class="cn">NA_real_</span>, sigma)</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initialize</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>  gamma <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA_real_</span>, n)</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>  kappa <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA_real_</span>, n)</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute skewness/kurtosis where safe</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>  valid <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="sc">!</span><span class="fu">is.na</span>(sigma_safe))</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(valid) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>    gamma[valid] <span class="ot">&lt;-</span> mu3[valid] <span class="sc">/</span> (sigma_safe[valid]<span class="sc">^</span><span class="dv">3</span>)</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>    kappa[valid] <span class="ot">&lt;-</span> mu4[valid] <span class="sc">/</span> (sigma_safe[valid]<span class="sc">^</span><span class="dv">4</span>)</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Optionally flag bad rows</span></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (return_flags) {</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>    flags <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>      <span class="at">zero_variance =</span> <span class="fu">is.na</span>(sigma_safe),</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>      <span class="at">negative_mu2  =</span> mu2 <span class="sc">&lt;</span> <span class="dv">0</span></span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">summary =</span> <span class="fu">data.frame</span>(mu, sigma, gamma, kappa), <span class="at">flags =</span> flags))</span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(mu, sigma, gamma, kappa)</span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply to training data</span></span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>train_responses <span class="ot">&lt;-</span> <span class="fu">calculate_summary_stats</span>(train_raw)</span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine predictors and responses</span></span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>train_processed <span class="ot">&lt;-</span> <span class="fu">cbind</span>(train_raw, train_responses)</span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(train_processed)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    St  Re    Fr R_moment_1 R_moment_2 R_moment_3 R_moment_4         mu
1 0.10 224 0.052 0.00215700  0.1303500   14.37400  1586.5000 0.00215700
2 3.00 224 0.052 0.00379030  0.4704200   69.94000 10404.0000 0.00379030
3 0.70 224   Inf 0.00290540  0.0434990    0.82200    15.5510 0.00290540
4 0.05  90   Inf 0.06352800  0.0906530    0.46746     3.2696 0.06352800
5 0.70 398   Inf 0.00036945  0.0062242    0.12649     2.5714 0.00036945
6 2.00  90 0.300 0.14780000  2.0068000   36.24900   671.6700 0.14780000
       sigma     gamma      kappa
1 0.36103372 305.42800 93371.6556
2 0.68586123 216.76225 47012.2515
3 0.20854390  90.58974  8216.7778
4 0.29430799  17.67980   420.2523
5 0.07889273 257.58554 66372.7845
6 1.40888437  12.64607   165.0999</code></pre>
</div>
</div>
</section>
<section id="feature-engineering-and-transformation" class="level3">
<h3 class="anchored" data-anchor-id="feature-engineering-and-transformation">2.2.1 Feature Engineering and Transformation</h3>
<p>Based on the exploratory analysis, we engineer the <code>Fr</code> variable and apply a log transformation to the highly skewed response variables and predictor variable St.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="do">## ---- feature-engineering-fixed, message=FALSE, warning=FALSE -----------------</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Feature engineering and safe inverse and log transforms</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>process_features <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  df <span class="sc">%&gt;%</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">is_gravity_present =</span> <span class="fu">ifelse</span>(<span class="fu">is.infinite</span>(Fr), <span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">inv_Fr             =</span> <span class="fu">ifelse</span>(<span class="fu">is.infinite</span>(Fr), <span class="dv">0</span>, <span class="dv">1</span> <span class="sc">/</span> Fr),</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">log_St             =</span> <span class="fu">ifelse</span>(St <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="fu">log</span>(St), <span class="cn">NA_real_</span>) </span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(St, log_St, Re, is_gravity_present, inv_Fr)</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>train_predictors_transformed <span class="ot">&lt;-</span> <span class="fu">process_features</span>(train_raw)</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>test_predictors  <span class="ot">&lt;-</span> <span class="fu">process_features</span>(test_raw)</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Safe log transformation for response variables</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>safe_log_transform <span class="ot">&lt;-</span> <span class="cf">function</span>(df, <span class="at">small =</span> <span class="fl">1e-8</span>) {</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>  df <span class="sc">%&gt;%</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">log_mu     =</span> <span class="fu">ifelse</span>(mu     <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="fu">log</span>(mu),     <span class="cn">NA_real_</span>),</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">log_sigma  =</span> <span class="fu">ifelse</span>(sigma  <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="fu">log</span>(sigma),  <span class="cn">NA_real_</span>),</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">log_gamma  =</span> <span class="fu">ifelse</span>(gamma  <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="fu">log</span>(gamma),  <span class="cn">NA_real_</span>),</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">log_kappa  =</span> <span class="fu">ifelse</span>(kappa  <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="fu">log</span>(kappa),  <span class="cn">NA_real_</span>)</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(log_mu, log_sigma, log_gamma, log_kappa)</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>train_responses_transformed <span class="ot">&lt;-</span> <span class="fu">safe_log_transform</span>(train_responses)</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>train_final <span class="ot">&lt;-</span> <span class="fu">cbind</span>(train_predictors_transformed, train_responses_transformed)</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify any problematic (NA or Inf) rows</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>problem_rows <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="sc">!</span><span class="fu">is.finite</span>(train_final<span class="sc">$</span>log_mu) <span class="sc">|</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>                      <span class="sc">!</span><span class="fu">is.finite</span>(train_final<span class="sc">$</span>log_sigma) <span class="sc">|</span></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>                      <span class="sc">!</span><span class="fu">is.finite</span>(train_final<span class="sc">$</span>log_gamma) <span class="sc">|</span></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>                      <span class="sc">!</span><span class="fu">is.finite</span>(train_final<span class="sc">$</span>log_kappa))</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(train_final)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    St     log_St  Re is_gravity_present    inv_Fr    log_mu  log_sigma
1 0.10 -2.3025851 224                  1 19.230769 -6.139037 -1.0187839
2 3.00  1.0986123 224                  1 19.230769 -5.575310 -0.3770800
3 0.70 -0.3566749 224                  0  0.000000 -5.841184 -1.5676057
4 0.05 -2.9957323  90                  0  0.000000 -2.756275 -1.2231285
5 0.70 -0.3566749 398                  0  0.000000 -7.903495 -2.5396661
6 2.00  0.6931472  90                  1  3.333333 -1.911895  0.3427982
  log_gamma log_kappa
1  5.721714 11.444343
2  5.378801 10.758164
3  4.506341  9.013933
4  2.872423  6.040855
5  5.551352 11.103042
6  2.537346  5.106550</code></pre>
</div>
</div>
</section>
<section id="univariate-eda-of-responses-for-current-and-transformation" class="level3">
<h3 class="anchored" data-anchor-id="univariate-eda-of-responses-for-current-and-transformation">2.2.2 Univariate EDA of Responses for Current and Transformation</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="do">## ---- two-faceted-plots, fig.width=10, fig.height=8, message=FALSE, warning=FALSE ----</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare separate before and after datasets</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>before_df <span class="ot">&lt;-</span> train_responses <span class="sc">%&gt;%</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">stage =</span> <span class="st">"Before Transformation"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(stage, mu, sigma, gamma, kappa) <span class="sc">%&gt;%</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(mu, sigma, gamma, kappa),</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"variable"</span>, <span class="at">values_to =</span> <span class="st">"value"</span>)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>after_df <span class="ot">&lt;-</span> train_final <span class="sc">%&gt;%</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">stage =</span> <span class="st">"After Transformation"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">mu =</span> log_mu, <span class="at">sigma =</span> log_sigma, <span class="at">gamma =</span> log_gamma, <span class="at">kappa =</span> log_kappa) <span class="sc">%&gt;%</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(stage, mu, sigma, gamma, kappa) <span class="sc">%&gt;%</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(mu, sigma, gamma, kappa),</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">"variable"</span>, <span class="at">values_to =</span> <span class="st">"value"</span>)</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="co"># --- BEFORE TRANSFORMATION ---</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(before_df, <span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">fill =</span> variable)) <span class="sc">+</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">30</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>, <span class="at">position =</span> <span class="st">"identity"</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> variable, <span class="at">scales =</span> <span class="st">"free"</span>, <span class="at">ncol =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">13</span>) <span class="sc">+</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Set2"</span>) <span class="sc">+</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Before Transformation: Distributions of Response Variables"</span>,</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Value"</span>, <span class="at">y =</span> <span class="st">"Frequency"</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">15</span>),</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Case-Study_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid" width="960"></p>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- AFTER TRANSFORMATION ---</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(after_df, <span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">fill =</span> variable)) <span class="sc">+</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">30</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>, <span class="at">position =</span> <span class="st">"identity"</span>, <span class="at">color =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> variable, <span class="at">scales =</span> <span class="st">"free"</span>, <span class="at">ncol =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">13</span>) <span class="sc">+</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Set2"</span>) <span class="sc">+</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"After Transformation: Distributions of Response Variables"</span>,</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Value"</span>, <span class="at">y =</span> <span class="st">"Frequency"</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">15</span>),</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Case-Study_files/figure-html/unnamed-chunk-1-2.png" class="img-fluid" width="960"></p>
</div>
</div>
</section>
<section id="bivariate-eda-of-responses-for-current-and-transformation" class="level3">
<h3 class="anchored" data-anchor-id="bivariate-eda-of-responses-for-current-and-transformation">2.2.3 Bivariate EDA of Responses for Current and Transformation</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(train_final, <span class="fu">aes</span>(<span class="at">x =</span> log_St, <span class="at">y =</span> log_mu, <span class="at">color =</span> <span class="fu">factor</span>(Re), <span class="at">shape =</span> <span class="fu">factor</span>(inv_Fr))) <span class="sc">+</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Log(St)"</span>,</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Log of Particle Distribution Mean"</span>,</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">"Re"</span>,</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">shape =</span> <span class="st">"1/Fe"</span>,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Particle Characteristic Value (St) vs Particle Distribution Mean"</span>,</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Factored by Reynold's Number (Re) and Gravitational Acceleration (Fe)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Case-Study_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid" width="960"></p>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(train_final, <span class="fu">aes</span>(<span class="at">x =</span> St, <span class="at">y =</span> <span class="fu">exp</span>(log_mu), <span class="at">color =</span> <span class="fu">factor</span>(Re), <span class="at">shape =</span> <span class="fu">factor</span>(inv_Fr))) <span class="sc">+</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"St"</span>,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Particle Distribution Mean"</span>,</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">"Re"</span>,</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">shape =</span> <span class="st">"1/Fe"</span>,</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Particle Characteristic Value (St) vs Particle Distribution Mean"</span>,</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Factored by Reynold's Number (Re) and Gravitational Acceleration (Fe)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Case-Study_files/figure-html/unnamed-chunk-2-2.png" class="img-fluid" width="960"></p>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(train_final, <span class="fu">aes</span>(<span class="at">x =</span> log_St, <span class="at">y =</span> log_sigma, <span class="at">color =</span> <span class="fu">factor</span>(Re), <span class="at">shape =</span> <span class="fu">factor</span>(inv_Fr))) <span class="sc">+</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Log(St)"</span>,</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Log(Sigma)"</span>,</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">"Re"</span>,</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">shape =</span> <span class="st">"1/Fe"</span>,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Particle Characteristic Value (St) vs Particle Distribution Sigma"</span>,</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Factored by Reynold's Number (Re) and Gravitational Acceleration (Fe)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Case-Study_files/figure-html/unnamed-chunk-2-3.png" class="img-fluid" width="960"></p>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(train_final, <span class="fu">aes</span>(<span class="at">x =</span> log_St, <span class="at">y =</span> log_sigma, <span class="at">color =</span> <span class="fu">factor</span>(Re), <span class="at">shape =</span> <span class="fu">factor</span>(inv_Fr))) <span class="sc">+</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Log(St)"</span>,</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Log(Sigma)"</span>,</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">"Re"</span>,</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">shape =</span> <span class="st">"1/Fe"</span>,</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Particle Characteristic Value (St) vs Particle Distribution Sigma"</span>,</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Factored by Reynold's Number (Re) and Gravitational Acceleration (Fe)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Case-Study_files/figure-html/unnamed-chunk-2-4.png" class="img-fluid" width="960"></p>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(train_final, <span class="fu">aes</span>(<span class="at">x =</span> log_St, <span class="at">y =</span> log_gamma, <span class="at">color =</span> <span class="fu">factor</span>(Re), <span class="at">shape =</span> <span class="fu">factor</span>(inv_Fr))) <span class="sc">+</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Log(St)"</span>,</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Log(Gamma)"</span>,</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">"Re"</span>,</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">shape =</span> <span class="st">"1/Fe"</span>,</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Particle Characteristic Value (St) vs Particle Distribution Gamma"</span>,</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Factored by Reynold's Number (Re) and Gravitational Acceleration (Fe)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Case-Study_files/figure-html/unnamed-chunk-2-5.png" class="img-fluid" width="960"></p>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(train_final, <span class="fu">aes</span>(<span class="at">x =</span> log_St, <span class="at">y =</span> log_kappa, <span class="at">color =</span> <span class="fu">factor</span>(Re), <span class="at">shape =</span> <span class="fu">factor</span>(inv_Fr))) <span class="sc">+</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Log(St)"</span>,</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Log(Kappa)"</span>,</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">"Re"</span>,</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">shape =</span> <span class="st">"1/Fe"</span>,</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Particle Characteristic Value (St) vs Particle Distribution Kappa"</span>,</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Factored by Reynold's Number (Re) and Gravitational Acceleration (Fe)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Case-Study_files/figure-html/unnamed-chunk-2-6.png" class="img-fluid" width="960"></p>
</div>
</div>
</section>
<section id="exploratory-data-analysis-eda" class="level3">
<h3 class="anchored" data-anchor-id="exploratory-data-analysis-eda">2.3. Exploratory Data Analysis (EDA)</h3>
<p>A summary of the final processed data, similar to Table 1 in the report.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate descriptive statistics for the final dataset</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>summary_table <span class="ot">&lt;-</span> <span class="fu">summary</span>(train_final)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the summary</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(summary_table)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       St             log_St              Re        is_gravity_present
 Min.   :0.0500   Min.   :-2.9957   Min.   : 90.0   Min.   :0.0000    
 1st Qu.:0.3000   1st Qu.:-1.2040   1st Qu.: 90.0   1st Qu.:0.0000    
 Median :0.7000   Median :-0.3567   Median :224.0   Median :1.0000    
 Mean   :0.8596   Mean   :-0.6148   Mean   :214.5   Mean   :0.6629    
 3rd Qu.:1.0000   3rd Qu.: 0.0000   3rd Qu.:224.0   3rd Qu.:1.0000    
 Max.   :3.0000   Max.   : 1.0986   Max.   :398.0   Max.   :1.0000    
     inv_Fr           log_mu         log_sigma         log_gamma    
 Min.   : 0.000   Min.   :-8.413   Min.   :-4.5992   Min.   :2.483  
 1st Qu.: 0.000   1st Qu.:-6.139   1st Qu.:-1.8552   1st Qu.:4.284  
 Median : 3.333   Median :-5.823   Median :-1.2580   Median :4.702  
 Mean   : 8.640   Mean   :-5.051   Mean   :-0.8494   Mean   :4.649  
 3rd Qu.:19.231   3rd Qu.:-2.432   3rd Qu.:-0.3205   3rd Qu.:5.597  
 Max.   :19.231   Max.   :-1.758   Max.   : 3.4755   Max.   :5.843  
   log_kappa     
 Min.   : 5.014  
 1st Qu.: 8.635  
 Median : 9.406  
 Mean   : 9.345  
 3rd Qu.:11.195  
 Max.   :11.792  </code></pre>
</div>
</div>
</section>
<section id="linear-fitting" class="level3">
<h3 class="anchored" data-anchor-id="linear-fitting">3. Linear Fitting</h3>
<p>We establish a baseline by fitting a linear model. This helps formally test for non-linearity.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 3. Baseline Model: Multivariate Linear Regression</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a list of response variables</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>responses <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"log_mu"</span>, <span class="st">"log_sigma"</span>, <span class="st">"log_gamma"</span>, <span class="st">"log_kappa"</span>)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>lm_models <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>lm_rmse <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through each response to build a model</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (response <span class="cf">in</span> responses) {</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>  formula_str <span class="ot">&lt;-</span> <span class="fu">paste</span>(response, <span class="st">"~ log_St * Re + log_St * inv_Fr + is_gravity_present"</span>)</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">as.formula</span>(formula_str), <span class="at">data =</span> train_final)</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>  lm_models[[response]] <span class="ot">&lt;-</span> model</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Print model summary</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"--- Linear Model Summary for"</span>, response, <span class="st">"---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">summary</span>(model))</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>(model)</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Diagnostic plots</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>))</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(model, <span class="at">main =</span> <span class="fu">paste</span>(<span class="st">"Linear Model Diagnostics for"</span>, response))</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check for multicollinearity</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- VIF for"</span>, response, <span class="st">"---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">vif</span>(model))</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Predict on test set and calculate RMSE</span></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>  predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(model, <span class="at">newdata =</span> test_predictors)</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Note: We don't have true values for the test set, so RMSE is calculated on training data for diagnostics</span></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>  train_preds <span class="ot">&lt;-</span> <span class="fu">predict</span>(model, <span class="at">newdata =</span> train_final)</span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>  rmse <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>((train_final[[response]] <span class="sc">-</span> train_preds)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>  lm_rmse[[response]] <span class="ot">&lt;-</span> rmse</span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Training RMSE for"</span>, response, <span class="st">":"</span>, rmse, <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- Linear Model Summary for log_mu ---

Call:
lm(formula = as.formula(formula_str), data = train_final)

Residuals:
    Min      1Q  Median      3Q     Max 
-0.8202 -0.6086  0.2837  0.4825  0.7651 

Coefficients:
                     Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)        -0.6721985  0.1910452  -3.519 0.000711 ***
log_St              0.2428634  0.1329873   1.826 0.071457 .  
Re                 -0.0194721  0.0006616 -29.434  &lt; 2e-16 ***
inv_Fr              0.0221405  0.0108734   2.036 0.044958 *  
is_gravity_present -0.4079125  0.1900942  -2.146 0.034842 *  
log_St:Re          -0.0001516  0.0005290  -0.287 0.775215    
log_St:inv_Fr      -0.0012936  0.0065406  -0.198 0.843702    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.5862 on 82 degrees of freedom
Multiple R-squared:  0.9361,    Adjusted R-squared:  0.9314 
F-statistic: 200.2 on 6 and 82 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
<div class="cell-output-display">
<p><img src="Case-Study_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="960"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- VIF for log_mu ---</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>            log_St                 Re             inv_Fr is_gravity_present 
          5.271437           1.431111           2.382366           2.091076 
         log_St:Re      log_St:inv_Fr 
          4.768897           2.231717 

Training RMSE for log_mu : 0.5627138 

--- Linear Model Summary for log_sigma ---

Call:
lm(formula = as.formula(formula_str), data = train_final)

Residuals:
    Min      1Q  Median      3Q     Max 
-2.2036 -0.4472 -0.1774  0.4958  1.9892 

Coefficients:
                     Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)         1.9945869  0.2816818   7.081 4.47e-10 ***
log_St              0.7353162  0.1960798   3.750 0.000328 ***
Re                 -0.0140829  0.0009754 -14.438  &lt; 2e-16 ***
inv_Fr              0.1214802  0.0160321   7.577 4.77e-11 ***
is_gravity_present -0.9280740  0.2802796  -3.311 0.001383 ** 
log_St:Re          -0.0015341  0.0007800  -1.967 0.052593 .  
log_St:inv_Fr       0.0012419  0.0096436   0.129 0.897846    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.8644 on 82 degrees of freedom
Multiple R-squared:  0.7979,    Adjusted R-squared:  0.7831 
F-statistic: 53.95 on 6 and 82 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
<div class="cell-output-display">
<p><img src="Case-Study_files/figure-html/unnamed-chunk-3-2.png" class="img-fluid" width="960"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- VIF for log_sigma ---</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>            log_St                 Re             inv_Fr is_gravity_present 
          5.271437           1.431111           2.382366           2.091076 
         log_St:Re      log_St:inv_Fr 
          4.768897           2.231717 

Training RMSE for log_sigma : 0.8296791 

--- Linear Model Summary for log_gamma ---

Call:
lm(formula = as.formula(formula_str), data = train_final)

Residuals:
    Min      1Q  Median      3Q     Max 
-1.1095 -0.6250  0.0293  0.5485  1.0717 

Coefficients:
                     Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)         3.1552562  0.1980162  15.934  &lt; 2e-16 ***
log_St              0.1134506  0.1378398   0.823  0.41286    
Re                  0.0044685  0.0006857   6.517 5.46e-09 ***
inv_Fr              0.0996511  0.0112702   8.842 1.48e-13 ***
is_gravity_present -0.5518587  0.1970305  -2.801  0.00635 ** 
log_St:Re          -0.0009094  0.0005483  -1.658  0.10105    
log_St:inv_Fr       0.0017522  0.0067793   0.258  0.79670    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.6076 on 82 degrees of freedom
Multiple R-squared:  0.731, Adjusted R-squared:  0.7113 
F-statistic: 37.14 on 6 and 82 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
<div class="cell-output-display">
<p><img src="Case-Study_files/figure-html/unnamed-chunk-3-3.png" class="img-fluid" width="960"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- VIF for log_gamma ---</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>            log_St                 Re             inv_Fr is_gravity_present 
          5.271437           1.431111           2.382366           2.091076 
         log_St:Re      log_St:inv_Fr 
          4.768897           2.231717 

Training RMSE for log_gamma : 0.5832464 

--- Linear Model Summary for log_kappa ---

Call:
lm(formula = as.formula(formula_str), data = train_final)

Residuals:
     Min       1Q   Median       3Q      Max 
-2.11612 -1.21534  0.03521  1.05915  1.95539 

Coefficients:
                    Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)         6.362896   0.383797  16.579  &lt; 2e-16 ***
log_St              0.122808   0.267162   0.460  0.64697    
Re                  0.008787   0.001329   6.612 3.59e-09 ***
inv_Fr              0.197611   0.021844   9.046 5.82e-14 ***
is_gravity_present -1.092790   0.381886  -2.862  0.00535 ** 
log_St:Re          -0.001602   0.001063  -1.507  0.13560    
log_St:inv_Fr       0.003907   0.013140   0.297  0.76698    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 1.178 on 82 degrees of freedom
Multiple R-squared:  0.737, Adjusted R-squared:  0.7178 
F-statistic: 38.31 on 6 and 82 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
<div class="cell-output-display">
<p><img src="Case-Study_files/figure-html/unnamed-chunk-3-4.png" class="img-fluid" width="960"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- VIF for log_kappa ---</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>            log_St                 Re             inv_Fr is_gravity_present 
          5.271437           1.431111           2.382366           2.091076 
         log_St:Re      log_St:inv_Fr 
          4.768897           2.231717 

Training RMSE for log_kappa : 1.130454 </code></pre>
</div>
</div>
<ol type="1">
<li>Model for log_mu and log_sigma (First &amp; Second Images)</li>
</ol>
<p>For the models predicting the log-transformed mean and standard deviation, the diagnostic plots reveal several significant issues:</p>
<p>Failure of Linearity Assumption: The Residuals vs.&nbsp;Fitted plots for both models show a distinct, curvilinear pattern in the residuals. The smoothed red line follows a clear U-shape rather than being flat and straight. This is a classic sign that the linear model is failing to capture the true underlying non-linear relationships in the data. It is systematically mis-predicting in different regions of the data.</p>
<p>Non-Normal Residuals: The Normal Q-Q plots show that the residuals deviate from the theoretical diagonal line, particularly at the tails. This indicates that the errors of the model are not normally distributed; specifically, they have heavier tails than a normal distribution would suggest, violating a key assumption of linear regression.</p>
<p>Non-Constant Variance (Heteroscedasticity): In the Scale-Location plot, especially for log_sigma, the smoothed line is not flat. It trends upwards, indicating that the variance of the residuals increases as the fitted (predicted) value gets larger. This means the model’s predictions are less reliable for larger-scale outcomes.</p>
<p>Presence of Influential Points: The Residuals vs.&nbsp;Leverage plots highlight that some data points have high leverage or large residuals. These points have an unusually strong influence on the estimated coefficients of the model, potentially making the fit unstable and sensitive to a small subset of the data.</p>
<p>Conclusion: For log_mu and log_sigma, the linear model is inadequate as it violates the core assumptions of linearity, normality of residuals, and constant variance.</p>
<ol start="2" type="1">
<li>Model for gamma (Skewness - Third Image)</li>
</ol>
<p>The diagnostics for the gamma model are even more problematic:</p>
<p>Dominance by an Extreme Outlier: All four diagnostic plots are dominated by a single, extreme point with a very large residual.</p>
<p>Severe Violation of Normality: The Normal Q-Q plot shows a catastrophic failure of the normality assumption. One point lies so far from the diagonal line that it renders the plot almost unreadable for the other points, indicating the model is completely unable to account for this observation.</p>
<p>Extreme Influence: The Residuals vs.&nbsp;Leverage plot confirms that this outlier is an extremely influential point, falling far outside the standard contours of Cook’s distance. This means this single data point is fundamentally distorting the entire model fit.</p>
<p>Conclusion: The linear model for gamma is invalid. It is not robust and its results are unreliable due to the overwhelming effect of at least one influential outlier.</p>
<ol start="3" type="1">
<li>Model for log_kappa (Kurtosis - Fourth Image)</li>
</ol>
<p>The diagnostics for log_kappa mirror the issues seen with log_mu and log_sigma:</p>
<p>Clear Non-Linearity: The Residuals vs.&nbsp;Fitted plot again shows a pronounced U-shaped pattern, failing the linearity assumption.</p>
<p>Non-Normal Residuals: The Normal Q-Q plot shows points peeling away from the diagonal line at the tails, violating the normality assumption.</p>
<p>Influential Points: The model is again sensitive to a few points with high leverage or large residuals.</p>
<p>Conclusion: The linear model for log_kappa is also a poor fit, failing on the same key assumptions as the other models.</p>
<p>Therefore, we must explore either more complex parametric models or non-linear models.</p>
</section>
<section id="b.-cubic-modeling" class="level3">
<h3 class="anchored" data-anchor-id="b.-cubic-modeling">3b. Cubic Modeling</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>cm_models <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>cm_rmse <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through each response to build a model</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (response <span class="cf">in</span> responses) {</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  formula_str <span class="ot">&lt;-</span> <span class="fu">paste</span>(response, <span class="st">"~ poly(log_St, 3, raw = TRUE)*Re*inv_Fr"</span>)</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">as.formula</span>(formula_str), <span class="at">data =</span> train_final)</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>  lm_models[[response]] <span class="ot">&lt;-</span> model</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Print model summary</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"--- Linear Model Summary for"</span>, response, <span class="st">"---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">summary</span>(model))</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>(model)</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Diagnostic plots</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>))</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(model, <span class="at">main =</span> <span class="fu">paste</span>(<span class="st">"Linear Model Diagnostics for"</span>, response))</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check for multicollinearity</span></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- VIF for"</span>, response, <span class="st">"---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">vif</span>(model))</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Predict on test set and calculate RMSE</span></span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>  predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(model, <span class="at">newdata =</span> test_predictors)</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Note: We don't have true values for the test set, so RMSE is calculated on training data for diagnostics</span></span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>  train_preds <span class="ot">&lt;-</span> <span class="fu">predict</span>(model, <span class="at">newdata =</span> train_final)</span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>  rmse <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>((train_final[[response]] <span class="sc">-</span> train_preds)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>  lm_rmse[[response]] <span class="ot">&lt;-</span> rmse</span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Training RMSE for"</span>, response, <span class="st">":"</span>, rmse, <span class="st">"</span><span class="sc">\n\n</span><span class="st">"</span>)</span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- Linear Model Summary for log_mu ---

Call:
lm(formula = as.formula(formula_str), data = train_final)

Residuals:
    Min      1Q  Median      3Q     Max 
-0.8440 -0.6187  0.3462  0.5095  0.9974 

Coefficients:
                                         Estimate Std. Error t value Pr(&gt;|t|)
(Intercept)                            -1.144e+00  3.022e-01  -3.786 0.000312
poly(log_St, 3, raw = TRUE)1            5.344e-01  3.370e-01   1.586 0.117127
poly(log_St, 3, raw = TRUE)2            4.314e-01  3.788e-01   1.139 0.258567
poly(log_St, 3, raw = TRUE)3            1.039e-01  1.278e-01   0.813 0.418922
Re                                     -1.843e-02  1.303e-03 -14.146  &lt; 2e-16
inv_Fr                                  2.499e-02  2.457e-02   1.017 0.312638
poly(log_St, 3, raw = TRUE)1:Re        -1.497e-03  1.555e-03  -0.963 0.338679
poly(log_St, 3, raw = TRUE)2:Re        -1.149e-03  1.926e-03  -0.597 0.552618
poly(log_St, 3, raw = TRUE)3:Re        -2.124e-04  6.026e-04  -0.353 0.725435
poly(log_St, 3, raw = TRUE)1:inv_Fr    -1.502e-02  2.653e-02  -0.566 0.572924
poly(log_St, 3, raw = TRUE)2:inv_Fr    -2.586e-02  3.040e-02  -0.851 0.397775
poly(log_St, 3, raw = TRUE)3:inv_Fr    -8.514e-03  1.065e-02  -0.800 0.426498
Re:inv_Fr                              -7.225e-05  9.911e-05  -0.729 0.468343
poly(log_St, 3, raw = TRUE)1:Re:inv_Fr  4.957e-05  1.120e-04   0.443 0.659314
poly(log_St, 3, raw = TRUE)2:Re:inv_Fr  1.044e-04  1.359e-04   0.769 0.444622
poly(log_St, 3, raw = TRUE)3:Re:inv_Fr  3.952e-05  4.802e-05   0.823 0.413185
                                          
(Intercept)                            ***
poly(log_St, 3, raw = TRUE)1              
poly(log_St, 3, raw = TRUE)2              
poly(log_St, 3, raw = TRUE)3              
Re                                     ***
inv_Fr                                    
poly(log_St, 3, raw = TRUE)1:Re           
poly(log_St, 3, raw = TRUE)2:Re           
poly(log_St, 3, raw = TRUE)3:Re           
poly(log_St, 3, raw = TRUE)1:inv_Fr       
poly(log_St, 3, raw = TRUE)2:inv_Fr       
poly(log_St, 3, raw = TRUE)3:inv_Fr       
Re:inv_Fr                                 
poly(log_St, 3, raw = TRUE)1:Re:inv_Fr    
poly(log_St, 3, raw = TRUE)2:Re:inv_Fr    
poly(log_St, 3, raw = TRUE)3:Re:inv_Fr    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.617 on 73 degrees of freedom
Multiple R-squared:  0.937, Adjusted R-squared:  0.924 
F-statistic: 72.34 on 15 and 73 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
<div class="cell-output-display">
<p><img src="Case-Study_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="960"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- VIF for log_mu ---</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                             GVIF Df GVIF^(1/(2*Df))
poly(log_St, 3, raw = TRUE)            728.366174  3        2.999565
Re                                       5.010147  1        2.238336
inv_Fr                                  10.984233  1        3.314247
poly(log_St, 3, raw = TRUE):Re        1166.709494  3        3.244595
poly(log_St, 3, raw = TRUE):inv_Fr    1236.492582  3        3.276161
Re:inv_Fr                               14.545184  1        3.813815
poly(log_St, 3, raw = TRUE):Re:inv_Fr 1702.654477  3        3.455581

Training RMSE for log_mu : 0.5588266 

--- Linear Model Summary for log_sigma ---

Call:
lm(formula = as.formula(formula_str), data = train_final)

Residuals:
     Min       1Q   Median       3Q      Max 
-1.47666 -0.35223  0.05101  0.37630  1.08276 

Coefficients:
                                         Estimate Std. Error t value Pr(&gt;|t|)
(Intercept)                             6.004e-02  2.749e-01   0.218    0.828
poly(log_St, 3, raw = TRUE)1            4.168e-01  3.066e-01   1.359    0.178
poly(log_St, 3, raw = TRUE)2            1.825e-01  3.447e-01   0.529    0.598
poly(log_St, 3, raw = TRUE)3            7.998e-02  1.163e-01   0.688    0.494
Re                                     -7.093e-03  1.185e-03  -5.984 7.45e-08
inv_Fr                                  2.282e-01  2.236e-02  10.207 1.06e-15
poly(log_St, 3, raw = TRUE)1:Re        -1.105e-03  1.415e-03  -0.781    0.437
poly(log_St, 3, raw = TRUE)2:Re         1.780e-04  1.752e-03   0.102    0.919
poly(log_St, 3, raw = TRUE)3:Re         1.685e-04  5.483e-04   0.307    0.759
poly(log_St, 3, raw = TRUE)1:inv_Fr    -2.492e-02  2.414e-02  -1.033    0.305
poly(log_St, 3, raw = TRUE)2:inv_Fr     1.679e-03  2.766e-02   0.061    0.952
poly(log_St, 3, raw = TRUE)3:inv_Fr     6.453e-03  9.688e-03   0.666    0.507
Re:inv_Fr                              -6.375e-04  9.018e-05  -7.070 7.73e-10
poly(log_St, 3, raw = TRUE)1:Re:inv_Fr  4.786e-05  1.019e-04   0.470    0.640
poly(log_St, 3, raw = TRUE)2:Re:inv_Fr  6.312e-06  1.236e-04   0.051    0.959
poly(log_St, 3, raw = TRUE)3:Re:inv_Fr -7.099e-06  4.369e-05  -0.162    0.871
                                          
(Intercept)                               
poly(log_St, 3, raw = TRUE)1              
poly(log_St, 3, raw = TRUE)2              
poly(log_St, 3, raw = TRUE)3              
Re                                     ***
inv_Fr                                 ***
poly(log_St, 3, raw = TRUE)1:Re           
poly(log_St, 3, raw = TRUE)2:Re           
poly(log_St, 3, raw = TRUE)3:Re           
poly(log_St, 3, raw = TRUE)1:inv_Fr       
poly(log_St, 3, raw = TRUE)2:inv_Fr       
poly(log_St, 3, raw = TRUE)3:inv_Fr       
Re:inv_Fr                              ***
poly(log_St, 3, raw = TRUE)1:Re:inv_Fr    
poly(log_St, 3, raw = TRUE)2:Re:inv_Fr    
poly(log_St, 3, raw = TRUE)3:Re:inv_Fr    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.5614 on 73 degrees of freedom
Multiple R-squared:  0.9241,    Adjusted R-squared:  0.9085 
F-statistic: 59.24 on 15 and 73 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
<div class="cell-output-display">
<p><img src="Case-Study_files/figure-html/unnamed-chunk-4-2.png" class="img-fluid" width="960"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- VIF for log_sigma ---</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                             GVIF Df GVIF^(1/(2*Df))
poly(log_St, 3, raw = TRUE)            728.366174  3        2.999565
Re                                       5.010147  1        2.238336
inv_Fr                                  10.984233  1        3.314247
poly(log_St, 3, raw = TRUE):Re        1166.709494  3        3.244595
poly(log_St, 3, raw = TRUE):inv_Fr    1236.492582  3        3.276161
Re:inv_Fr                               14.545184  1        3.813815
poly(log_St, 3, raw = TRUE):Re:inv_Fr 1702.654477  3        3.455581

Training RMSE for log_sigma : 0.5084525 

--- Linear Model Summary for log_gamma ---

Call:
lm(formula = as.formula(formula_str), data = train_final)

Residuals:
     Min       1Q   Median       3Q      Max 
-0.61253 -0.08548  0.00266  0.18352  0.42969 

Coefficients:
                                         Estimate Std. Error t value Pr(&gt;|t|)
(Intercept)                             1.786e+00  1.437e-01  12.429   &lt;2e-16
poly(log_St, 3, raw = TRUE)1           -3.151e-01  1.602e-01  -1.966   0.0531
poly(log_St, 3, raw = TRUE)2           -2.171e-01  1.801e-01  -1.206   0.2319
poly(log_St, 3, raw = TRUE)3           -3.849e-02  6.077e-02  -0.633   0.5284
Re                                      1.015e-02  6.194e-04  16.390   &lt;2e-16
inv_Fr                                  1.892e-01  1.168e-02  16.197   &lt;2e-16
poly(log_St, 3, raw = TRUE)1:Re         8.867e-04  7.391e-04   1.200   0.2341
poly(log_St, 3, raw = TRUE)2:Re         8.625e-04  9.156e-04   0.942   0.3493
poly(log_St, 3, raw = TRUE)3:Re         1.917e-04  2.865e-04   0.669   0.5055
poly(log_St, 3, raw = TRUE)1:inv_Fr    -1.089e-03  1.261e-02  -0.086   0.9314
poly(log_St, 3, raw = TRUE)2:inv_Fr     2.674e-02  1.445e-02   1.850   0.0684
poly(log_St, 3, raw = TRUE)3:inv_Fr     1.272e-02  5.062e-03   2.514   0.0142
Re:inv_Fr                              -5.036e-04  4.712e-05 -10.687   &lt;2e-16
poly(log_St, 3, raw = TRUE)1:Re:inv_Fr -8.851e-07  5.324e-05  -0.017   0.9868
poly(log_St, 3, raw = TRUE)2:Re:inv_Fr -1.044e-04  6.460e-05  -1.616   0.1105
poly(log_St, 3, raw = TRUE)3:Re:inv_Fr -5.019e-05  2.283e-05  -2.199   0.0311
                                          
(Intercept)                            ***
poly(log_St, 3, raw = TRUE)1           .  
poly(log_St, 3, raw = TRUE)2              
poly(log_St, 3, raw = TRUE)3              
Re                                     ***
inv_Fr                                 ***
poly(log_St, 3, raw = TRUE)1:Re           
poly(log_St, 3, raw = TRUE)2:Re           
poly(log_St, 3, raw = TRUE)3:Re           
poly(log_St, 3, raw = TRUE)1:inv_Fr       
poly(log_St, 3, raw = TRUE)2:inv_Fr    .  
poly(log_St, 3, raw = TRUE)3:inv_Fr    *  
Re:inv_Fr                              ***
poly(log_St, 3, raw = TRUE)1:Re:inv_Fr    
poly(log_St, 3, raw = TRUE)2:Re:inv_Fr    
poly(log_St, 3, raw = TRUE)3:Re:inv_Fr *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.2934 on 73 degrees of freedom
Multiple R-squared:  0.9442,    Adjusted R-squared:  0.9327 
F-statistic: 82.32 on 15 and 73 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
<div class="cell-output-display">
<p><img src="Case-Study_files/figure-html/unnamed-chunk-4-3.png" class="img-fluid" width="960"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- VIF for log_gamma ---</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                             GVIF Df GVIF^(1/(2*Df))
poly(log_St, 3, raw = TRUE)            728.366174  3        2.999565
Re                                       5.010147  1        2.238336
inv_Fr                                  10.984233  1        3.314247
poly(log_St, 3, raw = TRUE):Re        1166.709494  3        3.244595
poly(log_St, 3, raw = TRUE):inv_Fr    1236.492582  3        3.276161
Re:inv_Fr                               14.545184  1        3.813815
poly(log_St, 3, raw = TRUE):Re:inv_Fr 1702.654477  3        3.455581

Training RMSE for log_gamma : 0.2656794 

--- Linear Model Summary for log_kappa ---

Call:
lm(formula = as.formula(formula_str), data = train_final)

Residuals:
     Min       1Q   Median       3Q      Max 
-1.16999 -0.15164  0.02901  0.34292  0.79700 

Coefficients:
                                         Estimate Std. Error t value Pr(&gt;|t|)
(Intercept)                             3.652e+00  2.749e-01  13.285   &lt;2e-16
poly(log_St, 3, raw = TRUE)1           -6.597e-01  3.066e-01  -2.152   0.0347
poly(log_St, 3, raw = TRUE)2           -4.087e-01  3.446e-01  -1.186   0.2394
poly(log_St, 3, raw = TRUE)3           -8.154e-02  1.163e-01  -0.701   0.4854
Re                                      2.007e-02  1.185e-03  16.933   &lt;2e-16
inv_Fr                                  3.759e-01  2.235e-02  16.814   &lt;2e-16
poly(log_St, 3, raw = TRUE)1:Re         1.877e-03  1.414e-03   1.327   0.1885
poly(log_St, 3, raw = TRUE)2:Re         1.569e-03  1.752e-03   0.896   0.3733
poly(log_St, 3, raw = TRUE)3:Re         3.501e-04  5.481e-04   0.639   0.5250
poly(log_St, 3, raw = TRUE)1:inv_Fr     2.607e-03  2.413e-02   0.108   0.9142
poly(log_St, 3, raw = TRUE)2:inv_Fr     4.878e-02  2.766e-02   1.764   0.0819
poly(log_St, 3, raw = TRUE)3:inv_Fr     2.311e-02  9.685e-03   2.386   0.0196
Re:inv_Fr                              -9.977e-04  9.016e-05 -11.066   &lt;2e-16
poly(log_St, 3, raw = TRUE)1:Re:inv_Fr -1.246e-05  1.019e-04  -0.122   0.9030
poly(log_St, 3, raw = TRUE)2:Re:inv_Fr -1.949e-04  1.236e-04  -1.577   0.1191
poly(log_St, 3, raw = TRUE)3:Re:inv_Fr -9.413e-05  4.368e-05  -2.155   0.0345
                                          
(Intercept)                            ***
poly(log_St, 3, raw = TRUE)1           *  
poly(log_St, 3, raw = TRUE)2              
poly(log_St, 3, raw = TRUE)3              
Re                                     ***
inv_Fr                                 ***
poly(log_St, 3, raw = TRUE)1:Re           
poly(log_St, 3, raw = TRUE)2:Re           
poly(log_St, 3, raw = TRUE)3:Re           
poly(log_St, 3, raw = TRUE)1:inv_Fr       
poly(log_St, 3, raw = TRUE)2:inv_Fr    .  
poly(log_St, 3, raw = TRUE)3:inv_Fr    *  
Re:inv_Fr                              ***
poly(log_St, 3, raw = TRUE)1:Re:inv_Fr    
poly(log_St, 3, raw = TRUE)2:Re:inv_Fr    
poly(log_St, 3, raw = TRUE)3:Re:inv_Fr *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.5613 on 73 degrees of freedom
Multiple R-squared:  0.9468,    Adjusted R-squared:  0.9359 
F-statistic: 86.66 on 15 and 73 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
<div class="cell-output-display">
<p><img src="Case-Study_files/figure-html/unnamed-chunk-4-4.png" class="img-fluid" width="960"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- VIF for log_kappa ---</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>                                             GVIF Df GVIF^(1/(2*Df))
poly(log_St, 3, raw = TRUE)            728.366174  3        2.999565
Re                                       5.010147  1        2.238336
inv_Fr                                  10.984233  1        3.314247
poly(log_St, 3, raw = TRUE):Re        1166.709494  3        3.244595
poly(log_St, 3, raw = TRUE):inv_Fr    1236.492582  3        3.276161
Re:inv_Fr                               14.545184  1        3.813815
poly(log_St, 3, raw = TRUE):Re:inv_Fr 1702.654477  3        3.455581

Training RMSE for log_kappa : 0.5083405 </code></pre>
</div>
</div>
</section>
<section id="advanced-modeling-generalized-additive-models-gams" class="level3">
<h3 class="anchored" data-anchor-id="advanced-modeling-generalized-additive-models-gams">4. Advanced Modeling: Generalized Additive Models (GAMs)</h3>
<p>The linear model diagnostics clearly showed that a simple linear relationship is not appropriate. We will now fit a Generalized Additive Model (GAM) for each response.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare data for factor modeling</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="co"># We use the original 'Re' and 'inv_Fr' and explicitly make them factors.</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>train_final_gam <span class="ot">&lt;-</span> train_final <span class="sc">%&gt;%</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">log_St_s =</span> <span class="fu">as.numeric</span>(<span class="fu">scale</span>(log_St)), <span class="co"># Keep scaled continuous variable</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">Re =</span> <span class="fu">factor</span>(Re),               <span class="co"># Treat as a factor</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">inv_Fr =</span> <span class="fu">factor</span>(<span class="fu">round</span>(inv_Fr, <span class="dv">4</span>)), <span class="co"># Round to clean up levels, then factor</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_gravity_present =</span> <span class="fu">factor</span>(is_gravity_present)</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="co"># We need to apply the same factor levels to the test data</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Get levels from training data</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>re_levels <span class="ot">&lt;-</span> <span class="fu">levels</span>(train_final_gam<span class="sc">$</span>Re)</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>fr_levels <span class="ot">&lt;-</span> <span class="fu">levels</span>(train_final_gam<span class="sc">$</span>inv_Fr)</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>grav_levels <span class="ot">&lt;-</span> <span class="fu">levels</span>(train_final_gam<span class="sc">$</span>is_gravity_present)</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Process test predictors</span></span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>test_predictors_gam <span class="ot">&lt;-</span> test_predictors <span class="sc">%&gt;%</span></span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">log_St_s =</span> <span class="fu">as.numeric</span>(<span class="fu">scale</span>(log_St, <span class="at">center =</span> <span class="fu">mean</span>(train_final<span class="sc">$</span>log_St), <span class="at">scale =</span> <span class="fu">sd</span>(train_final<span class="sc">$</span>log_St))),</span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">Re =</span> <span class="fu">factor</span>(Re, <span class="at">levels =</span> re_levels),</span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">inv_Fr =</span> <span class="fu">factor</span>(<span class="fu">round</span>(inv_Fr, <span class="dv">4</span>), <span class="at">levels =</span> fr_levels),</span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_gravity_present =</span> <span class="fu">factor</span>(is_gravity_present, <span class="at">levels =</span> grav_levels)</span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a>responses <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"log_mu"</span>, <span class="st">"log_sigma"</span>, <span class="st">"log_gamma"</span>, <span class="st">"log_kappa"</span>)</span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a>gam_models <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (response <span class="cf">in</span> responses) {</span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># s(St_s):            A global smooth effect of St</span></span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Re:                 A main effect for each Re level (different intercept)</span></span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># inv_Fr:             A main effect for each inv_Fr level</span></span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># is_gravity_present: A main effect for gravity</span></span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># s(St_s, by = Re):    *separate* smooth of St for *each* #                     level of Re. This models the interaction.</span></span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># s(St_s, by = inv_Fr): Models the interaction of St and inv_Fr.</span></span>
<span id="cb38-38"><a href="#cb38-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-39"><a href="#cb38-39" aria-hidden="true" tabindex="-1"></a>  formula_gam <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(</span>
<span id="cb38-40"><a href="#cb38-40" aria-hidden="true" tabindex="-1"></a>    response, </span>
<span id="cb38-41"><a href="#cb38-41" aria-hidden="true" tabindex="-1"></a>    <span class="st">"~ s(log_St_s) + Re + inv_Fr + is_gravity_present + s(log_St_s, by = Re) + s(log_St_s, by = inv_Fr)"</span></span>
<span id="cb38-42"><a href="#cb38-42" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb38-43"><a href="#cb38-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-44"><a href="#cb38-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Fitting GAM for"</span>, response, <span class="st">"---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb38-45"><a href="#cb38-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Using formula:</span><span class="sc">\n</span><span class="st">"</span>); <span class="fu">print</span>(formula_gam)</span>
<span id="cb38-46"><a href="#cb38-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-47"><a href="#cb38-47" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">gam</span>(</span>
<span id="cb38-48"><a href="#cb38-48" aria-hidden="true" tabindex="-1"></a>    formula_gam,</span>
<span id="cb38-49"><a href="#cb38-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> train_final_gam,</span>
<span id="cb38-50"><a href="#cb38-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> <span class="st">"REML"</span>, <span class="co"># Recommended for stable smoothness</span></span>
<span id="cb38-51"><a href="#cb38-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">select =</span> <span class="cn">TRUE</span>   <span class="co"># Allows model to penalize smooths to zero</span></span>
<span id="cb38-52"><a href="#cb38-52" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb38-53"><a href="#cb38-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-54"><a href="#cb38-54" aria-hidden="true" tabindex="-1"></a>  gam_models[[response]] <span class="ot">&lt;-</span> model</span>
<span id="cb38-55"><a href="#cb38-55" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-56"><a href="#cb38-56" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Print the model summary</span></span>
<span id="cb38-57"><a href="#cb38-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- GAM Summary for"</span>, response, <span class="st">"---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb38-58"><a href="#cb38-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">summary</span>(model))</span>
<span id="cb38-59"><a href="#cb38-59" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-60"><a href="#cb38-60" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check diagnostics</span></span>
<span id="cb38-61"><a href="#cb38-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- GAM Diagnostics for"</span>, response, <span class="st">"---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb38-62"><a href="#cb38-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>))</span>
<span id="cb38-63"><a href="#cb38-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gam.check</span>(model)</span>
<span id="cb38-64"><a href="#cb38-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb38-65"><a href="#cb38-65" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-66"><a href="#cb38-66" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot the learned smooths</span></span>
<span id="cb38-67"><a href="#cb38-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Plotting smooths for"</span>, response, <span class="st">"---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb38-68"><a href="#cb38-68" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This will now show the main effect of St, and then </span></span>
<span id="cb38-69"><a href="#cb38-69" aria-hidden="true" tabindex="-1"></a>  <span class="co"># the *three separate interaction smooths* for s(St_s):Re90, etc.</span></span>
<span id="cb38-70"><a href="#cb38-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(model, <span class="at">pages =</span> <span class="dv">1</span>, <span class="at">all.terms =</span> <span class="cn">TRUE</span>, <span class="at">rug =</span> <span class="cn">TRUE</span>, <span class="at">se =</span> <span class="cn">TRUE</span>, <span class="at">residuals =</span> <span class="cn">TRUE</span>)</span>
<span id="cb38-71"><a href="#cb38-71" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-72"><a href="#cb38-72" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Fitting GAM for log_mu ---
Using formula:
log_mu ~ s(log_St_s) + Re + inv_Fr + is_gravity_present + s(log_St_s, 
    by = Re) + s(log_St_s, by = inv_Fr)

--- GAM Summary for log_mu ---

Family: gaussian 
Link function: identity 

Formula:
log_mu ~ s(log_St_s) + Re + inv_Fr + is_gravity_present + s(log_St_s, 
    by = Re) + s(log_St_s, by = inv_Fr)

Parametric coefficients:
                    Estimate Std. Error  t value Pr(&gt;|t|)    
(Intercept)         -2.20566    0.02709  -81.425  &lt; 2e-16 ***
Re224               -3.63783    0.02700 -134.759  &lt; 2e-16 ***
Re398               -5.76977    0.03396 -169.923  &lt; 2e-16 ***
inv_Fr3.3333         0.00000    0.00000      NaN      NaN    
inv_Fr19.2308        0.12511    0.03074    4.069 0.000114 ***
is_gravity_present1 -0.10161    0.03212   -3.164 0.002238 ** 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Approximate significance of smooth terms:
                                edf Ref.df     F  p-value    
s(log_St_s)               2.932e+00      9 8.385  &lt; 2e-16 ***
s(log_St_s):Re90          8.578e-06      9 0.000 0.523053    
s(log_St_s):Re224         1.012e-05      9 0.000 0.434604    
s(log_St_s):Re398         6.410e-01      9 0.201 0.094567 .  
s(log_St_s):inv_Fr0       3.329e+00      9 2.010 0.000319 ***
s(log_St_s):inv_Fr3.3333  9.018e-01      9 0.910 0.001747 ** 
s(log_St_s):inv_Fr19.2308 2.179e-06      9 0.000 0.022993 *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Rank: 68/69
R-sq.(adj) =  0.998   Deviance explained = 99.8%
-REML = -45.176  Scale est. = 0.012198  n = 89

--- GAM Diagnostics for log_mu ---</code></pre>
</div>
<div class="cell-output-display">
<p><img src="Case-Study_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid" width="960"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Method: REML   Optimizer: outer newton
full convergence after 19 iterations.
Gradient range [-6.76402e-06,1.114473e-05]
(score -45.17583 &amp; scale 0.01219836).
Hessian positive definite, eigenvalue range [9.466758e-08,41.58071].
Model rank =  68 / 69 

Basis dimension (k) checking results. Low p-value (k-index&lt;1) may
indicate that k is too low, especially if edf is close to k'.

                                k'      edf k-index p-value
s(log_St_s)               9.00e+00 2.93e+00    0.98    0.39
s(log_St_s):Re90          9.00e+00 8.58e-06    0.98    0.49
s(log_St_s):Re224         9.00e+00 1.01e-05    0.98    0.42
s(log_St_s):Re398         9.00e+00 6.41e-01    0.98    0.43
s(log_St_s):inv_Fr0       9.00e+00 3.33e+00    0.98    0.46
s(log_St_s):inv_Fr3.3333  9.00e+00 9.02e-01    0.98    0.39
s(log_St_s):inv_Fr19.2308 9.00e+00 2.18e-06    0.98    0.43

--- Plotting smooths for log_mu ---</code></pre>
</div>
<div class="cell-output-display">
<p><img src="Case-Study_files/figure-html/unnamed-chunk-5-2.png" class="img-fluid" width="960"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Fitting GAM for log_sigma ---
Using formula:
log_sigma ~ s(log_St_s) + Re + inv_Fr + is_gravity_present + 
    s(log_St_s, by = Re) + s(log_St_s, by = inv_Fr)

--- GAM Summary for log_sigma ---

Family: gaussian 
Link function: identity 

Formula:
log_sigma ~ s(log_St_s) + Re + inv_Fr + is_gravity_present + 
    s(log_St_s, by = Re) + s(log_St_s, by = inv_Fr)

Parametric coefficients:
                    Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)           0.5574     0.1803   3.091  0.00275 ** 
Re224                -2.3471     0.1787 -13.136  &lt; 2e-16 ***
Re398                -3.9628     0.2254 -17.581  &lt; 2e-16 ***
inv_Fr3.3333         -0.3936     0.2165  -1.818  0.07277 .  
inv_Fr19.2308         1.4147     0.1841   7.686 3.43e-11 ***
is_gravity_present1   0.0000     0.0000     NaN      NaN    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Approximate significance of smooth terms:
                                edf Ref.df     F  p-value    
s(log_St_s)               1.237e+00      9 0.277 0.098286 .  
s(log_St_s):Re90          9.125e-01      9 1.167 0.000195 ***
s(log_St_s):Re224         2.298e+00      9 1.661  9.5e-05 ***
s(log_St_s):Re398         1.352e-05      9 0.000 0.977362    
s(log_St_s):inv_Fr0       7.347e-06      9 0.000 0.890667    
s(log_St_s):inv_Fr3.3333  1.616e-05      9 0.000 0.814039    
s(log_St_s):inv_Fr19.2308 5.200e-06      9 0.000 0.851804    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Rank: 68/69
R-sq.(adj) =  0.841   Deviance explained = 85.6%
-REML = 106.88  Scale est. = 0.54902   n = 89

--- GAM Diagnostics for log_sigma ---</code></pre>
</div>
<div class="cell-output-display">
<p><img src="Case-Study_files/figure-html/unnamed-chunk-5-3.png" class="img-fluid" width="960"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Method: REML   Optimizer: outer newton
full convergence after 13 iterations.
Gradient range [-6.22428e-06,1.32106e-05]
(score 106.876 &amp; scale 0.54902).
Hessian positive definite, eigenvalue range [2.078582e-07,41.53167].
Model rank =  68 / 69 

Basis dimension (k) checking results. Low p-value (k-index&lt;1) may
indicate that k is too low, especially if edf is close to k'.

                                k'      edf k-index p-value
s(log_St_s)               9.00e+00 1.24e+00       1    0.47
s(log_St_s):Re90          9.00e+00 9.12e-01       1    0.39
s(log_St_s):Re224         9.00e+00 2.30e+00       1    0.42
s(log_St_s):Re398         9.00e+00 1.35e-05       1    0.42
s(log_St_s):inv_Fr0       9.00e+00 7.35e-06       1    0.45
s(log_St_s):inv_Fr3.3333  9.00e+00 1.62e-05       1    0.48
s(log_St_s):inv_Fr19.2308 9.00e+00 5.20e-06       1    0.50

--- Plotting smooths for log_sigma ---</code></pre>
</div>
<div class="cell-output-display">
<p><img src="Case-Study_files/figure-html/unnamed-chunk-5-4.png" class="img-fluid" width="960"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Fitting GAM for log_gamma ---
Using formula:
log_gamma ~ s(log_St_s) + Re + inv_Fr + is_gravity_present + 
    s(log_St_s, by = Re) + s(log_St_s, by = inv_Fr)

--- GAM Summary for log_gamma ---

Family: gaussian 
Link function: identity 

Formula:
log_gamma ~ s(log_St_s) + Re + inv_Fr + is_gravity_present + 
    s(log_St_s, by = Re) + s(log_St_s, by = inv_Fr)

Parametric coefficients:
                    Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)           3.3943     0.1366  24.841  &lt; 2e-16 ***
Re224                 1.0750     0.1357   7.924 9.26e-12 ***
Re398                 1.4817     0.1708   8.676 2.93e-13 ***
inv_Fr3.3333         -0.2964     0.1630  -1.818   0.0726 .  
inv_Fr19.2308         1.3477     0.1401   9.618 3.84e-15 ***
is_gravity_present1   0.0000     0.0000     NaN      NaN    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Approximate significance of smooth terms:
                                edf Ref.df     F p-value  
s(log_St_s)               3.766e-01      9 0.048  0.2997  
s(log_St_s):Re90          1.991e-05      9 0.000  0.5278  
s(log_St_s):Re224         2.123e-05      9 0.000  0.5455  
s(log_St_s):Re398         7.101e-01      9 0.274  0.0604 .
s(log_St_s):inv_Fr0       1.484e-05      9 0.000  0.6305  
s(log_St_s):inv_Fr3.3333  2.695e-05      9 0.000  0.5068  
s(log_St_s):inv_Fr19.2308 1.076e-05      9 0.000  0.9281  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Rank: 68/69
R-sq.(adj) =  0.752   Deviance explained = 76.6%
-REML = 79.299  Scale est. = 0.31751   n = 89

--- GAM Diagnostics for log_gamma ---</code></pre>
</div>
<div class="cell-output-display">
<p><img src="Case-Study_files/figure-html/unnamed-chunk-5-5.png" class="img-fluid" width="960"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Method: REML   Optimizer: outer newton
full convergence after 13 iterations.
Gradient range [-4.953508e-06,2.378216e-05]
(score 79.29854 &amp; scale 0.3175092).
Hessian positive definite, eigenvalue range [4.063444e-07,41.50389].
Model rank =  68 / 69 

Basis dimension (k) checking results. Low p-value (k-index&lt;1) may
indicate that k is too low, especially if edf is close to k'.

                                k'      edf k-index p-value
s(log_St_s)               9.00e+00 3.77e-01    1.01    0.42
s(log_St_s):Re90          9.00e+00 1.99e-05    1.01    0.47
s(log_St_s):Re224         9.00e+00 2.12e-05    1.01    0.56
s(log_St_s):Re398         9.00e+00 7.10e-01    1.01    0.46
s(log_St_s):inv_Fr0       9.00e+00 1.48e-05    1.01    0.56
s(log_St_s):inv_Fr3.3333  9.00e+00 2.70e-05    1.01    0.48
s(log_St_s):inv_Fr19.2308 9.00e+00 1.08e-05    1.01    0.54

--- Plotting smooths for log_gamma ---</code></pre>
</div>
<div class="cell-output-display">
<p><img src="Case-Study_files/figure-html/unnamed-chunk-5-6.png" class="img-fluid" width="960"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Fitting GAM for log_kappa ---
Using formula:
log_kappa ~ s(log_St_s) + Re + inv_Fr + is_gravity_present + 
    s(log_St_s, by = Re) + s(log_St_s, by = inv_Fr)

--- GAM Summary for log_kappa ---

Family: gaussian 
Link function: identity 

Formula:
log_kappa ~ s(log_St_s) + Re + inv_Fr + is_gravity_present + 
    s(log_St_s, by = Re) + s(log_St_s, by = inv_Fr)

Parametric coefficients:
                    Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)           6.8914     0.2655  25.959  &lt; 2e-16 ***
Re224                 2.0920     0.2636   7.937 8.81e-12 ***
Re398                 2.8771     0.3319   8.670 3.05e-13 ***
inv_Fr3.3333         -0.5928     0.3167  -1.872   0.0648 .  
inv_Fr19.2308         2.6643     0.2722   9.788 1.78e-15 ***
is_gravity_present1   0.0000     0.0000     NaN      NaN    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Approximate significance of smooth terms:
                                edf Ref.df     F p-value  
s(log_St_s)               5.164e-01      9 0.076  0.2536  
s(log_St_s):Re90          2.897e-05      9 0.000  0.6527  
s(log_St_s):Re224         7.329e-05      9 0.000  0.4626  
s(log_St_s):Re398         6.915e-01      9 0.251  0.0675 .
s(log_St_s):inv_Fr0       3.515e-05      9 0.000  0.6303  
s(log_St_s):inv_Fr3.3333  1.559e-04      9 0.000  0.4364  
s(log_St_s):inv_Fr19.2308 2.354e-05      9 0.000  0.9946  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Rank: 68/69
R-sq.(adj) =  0.756   Deviance explained = 77.1%
-REML = 134.48  Scale est. = 1.1983    n = 89

--- GAM Diagnostics for log_kappa ---</code></pre>
</div>
<div class="cell-output-display">
<p><img src="Case-Study_files/figure-html/unnamed-chunk-5-7.png" class="img-fluid" width="960"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Method: REML   Optimizer: outer newton
full convergence after 11 iterations.
Gradient range [-2.042395e-05,9.672587e-05]
(score 134.4827 &amp; scale 1.198282).
Hessian positive definite, eigenvalue range [6.386224e-07,41.50441].
Model rank =  68 / 69 

Basis dimension (k) checking results. Low p-value (k-index&lt;1) may
indicate that k is too low, especially if edf is close to k'.

                                k'      edf k-index p-value
s(log_St_s)               9.00e+00 5.16e-01    1.02    0.54
s(log_St_s):Re90          9.00e+00 2.90e-05    1.02    0.54
s(log_St_s):Re224         9.00e+00 7.33e-05    1.02    0.53
s(log_St_s):Re398         9.00e+00 6.92e-01    1.02    0.52
s(log_St_s):inv_Fr0       9.00e+00 3.51e-05    1.02    0.49
s(log_St_s):inv_Fr3.3333  9.00e+00 1.56e-04    1.02    0.52
s(log_St_s):inv_Fr19.2308 9.00e+00 2.35e-05    1.02    0.56

--- Plotting smooths for log_kappa ---</code></pre>
</div>
<div class="cell-output-display">
<p><img src="Case-Study_files/figure-html/unnamed-chunk-5-8.png" class="img-fluid" width="960"></p>
</div>
</div>
<p>Our first-pass Generalized Additive Models strongly validate the move from a linear framework, with the log_mu model’s R-squared of 0.997 and an effective degrees of freedom (edf) of 5.6 for the Stokes number smooth term providing conclusive proof of the non-linearity that the lm diagnostics merely suggested. This flexible approach also reveals key scientific insights, such as the log_mu model being driven primarily by a specific interaction between particle inertia and high gravity, while the log_kappa model is appropriately simplified to a purely parametric form. However, these diagnostics are equally critical for identifying model flaws: the log_sigma model’s gam.check() p-values are universally low, warning us that its basis dimension is too restrictive (k=9) and the fit is unreliable. Furthermore, perfect collinearity is evident as the is_gravity_present term is redundant with the inv_Fr factor, necessitating its removal. Therefore, our next iteration must correct these issues by increasing k and simplifying the model formula to achieve a final, robust fit.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>train_final_gam_V2 <span class="ot">&lt;-</span> train_final <span class="sc">%&gt;%</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">log_St_s =</span> <span class="fu">as.numeric</span>(<span class="fu">scale</span>(log_St)), <span class="co">#Scaled log continous variable</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">St_s =</span> <span class="fu">as.numeric</span>(<span class="fu">scale</span>(St)), <span class="co"># Scaled continuous variable</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">Re_factor =</span> <span class="fu">factor</span>(Re),                  <span class="co"># Treat as a factor</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">Fr_factor =</span> <span class="fu">factor</span>(<span class="fu">round</span>(inv_Fr, <span class="dv">4</span>)), <span class="co"># Round to clean up levels, then factor</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_gravity_present =</span> <span class="fu">factor</span>(is_gravity_present, <span class="at">levels =</span> grav_levels)</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a><span class="co"># --- *exact same* transformation to the test data ---</span></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>log_st_mean_V2 <span class="ot">&lt;-</span> <span class="fu">mean</span>(train_final<span class="sc">$</span>log_St)</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>log_st_sd_V2 <span class="ot">&lt;-</span> <span class="fu">sd</span>(train_final<span class="sc">$</span>log_St)</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>re_levels_V2 <span class="ot">&lt;-</span> <span class="fu">levels</span>(train_final_gam_V2<span class="sc">$</span>Re_factor)</span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>fr_levels_V2 <span class="ot">&lt;-</span> <span class="fu">levels</span>(train_final_gam_V2<span class="sc">$</span>Fr_factor)</span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Process test predictors</span></span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>test_predictors_gam_V2 <span class="ot">&lt;-</span> test_predictors <span class="sc">%&gt;%</span></span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">log_St_s =</span> (log_St <span class="sc">-</span> log_st_mean_V2) <span class="sc">/</span> log_st_sd_V2,</span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">Re_factor =</span> <span class="fu">factor</span>(Re, <span class="at">levels =</span> re_levels_V2),</span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">Fr_factor =</span> <span class="fu">factor</span>(<span class="fu">round</span>(inv_Fr, <span class="dv">4</span>), <span class="at">levels =</span> fr_levels_V2)</span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a>responses <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"log_mu"</span>, <span class="st">"log_sigma"</span>, <span class="st">"log_gamma"</span>, <span class="st">"log_kappa"</span>)</span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a>gam_models_V3 <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-28"><a href="#cb47-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Final Justified Models (The Real V3)</span></span>
<span id="cb47-29"><a href="#cb47-29" aria-hidden="true" tabindex="-1"></a>final_models <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb47-30"><a href="#cb47-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-31"><a href="#cb47-31" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 1. Final Model for log_mu ---</span></span>
<span id="cb47-32"><a href="#cb47-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Based on the summary, we remove the non-significant terms.</span></span>
<span id="cb47-33"><a href="#cb47-33" aria-hidden="true" tabindex="-1"></a>formula_log_mu <span class="ot">&lt;-</span> log_mu <span class="sc">~</span> Re_factor <span class="sc">+</span> <span class="fu">s</span>(log_St_s, <span class="at">k=</span><span class="dv">8</span>)</span>
<span id="cb47-34"><a href="#cb47-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-35"><a href="#cb47-35" aria-hidden="true" tabindex="-1"></a>model_log_mu <span class="ot">&lt;-</span> <span class="fu">gam</span>(formula_log_mu, <span class="at">data =</span> train_final_gam_V2, <span class="at">method =</span> <span class="st">"REML"</span>, <span class="at">na.action =</span> na.exclude)</span>
<span id="cb47-36"><a href="#cb47-36" aria-hidden="true" tabindex="-1"></a>final_models[[<span class="st">"log_mu"</span>]] <span class="ot">&lt;-</span> model_log_mu</span>
<span id="cb47-37"><a href="#cb47-37" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">summary</span>(model_log_mu))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Family: gaussian 
Link function: identity 

Formula:
log_mu ~ Re_factor + s(log_St_s, k = 8)

Parametric coefficients:
             Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  -2.23032    0.02406  -92.71   &lt;2e-16 ***
Re_factor224 -3.63783    0.03224 -112.83   &lt;2e-16 ***
Re_factor398 -5.74437    0.03910 -146.91   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Approximate significance of smooth terms:
              edf Ref.df    F p-value    
s(log_St_s) 3.381  4.157 55.2  &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

R-sq.(adj) =  0.996   Deviance explained = 99.7%
-REML = -40.772  Scale est. = 0.017807  n = 89</code></pre>
</div>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">gam.check</span>(model_log_mu)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Case-Study_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="960"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Method: REML   Optimizer: outer newton
full convergence after 6 iterations.
Gradient range [-8.969039e-10,7.015277e-12]
(score -40.77158 &amp; scale 0.01780716).
Hessian positive definite, eigenvalue range [0.7890376,42.53398].
Model rank =  10 / 10 

Basis dimension (k) checking results. Low p-value (k-index&lt;1) may
indicate that k is too low, especially if edf is close to k'.

              k'  edf k-index p-value
s(log_St_s) 7.00 3.38    1.02    0.52</code></pre>
</div>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 2. Final Model for log_sigma ---</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Evidence: Only the GLOBAL s(St_s) was significant. All 'by' interactions were not.</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Fitting Final Justified Model for log_sigma ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Fitting Final Justified Model for log_sigma ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>formula_log_sigma <span class="ot">&lt;-</span> log_sigma <span class="sc">~</span> <span class="fu">s</span>(log_St_s, <span class="at">k=</span><span class="dv">9</span>) <span class="sc">+</span> Re_factor <span class="sc">+</span> Fr_factor</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>model_log_sigma <span class="ot">&lt;-</span> <span class="fu">gam</span>(formula_log_sigma, <span class="at">data =</span> train_final_gam_V2, <span class="at">method =</span> <span class="st">"REML"</span>, <span class="at">na.action =</span> na.exclude)</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>final_models[[<span class="st">"log_sigma"</span>]] <span class="ot">&lt;-</span> model_log_sigma</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">summary</span>(model_log_sigma))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Family: gaussian 
Link function: identity 

Formula:
log_sigma ~ s(log_St_s, k = 9) + Re_factor + Fr_factor

Parametric coefficients:
                 Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)        0.5957     0.1854   3.213  0.00189 ** 
Re_factor224      -2.3512     0.1844 -12.750  &lt; 2e-16 ***
Re_factor398      -4.0005     0.2326 -17.202  &lt; 2e-16 ***
Fr_factor3.3333   -0.4246     0.2213  -1.918  0.05862 .  
Fr_factor19.2308   1.3572     0.1894   7.165 3.24e-10 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Approximate significance of smooth terms:
              edf Ref.df     F  p-value    
s(log_St_s) 3.043  3.763 12.26 2.74e-07 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

R-sq.(adj) =  0.831   Deviance explained = 84.4%
-REML = 107.45  Scale est. = 0.58298   n = 89</code></pre>
</div>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This summary will be much cleaner and all terms should be significant.</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 3. Final Model for log_gamma ---</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Evidence: NO smooth terms were significant. The model is purely parametric.</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a><span class="co"># We should use a simple, robust lm()</span></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Fitting Final Justified Model for log_gamma ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Fitting Final Justified Model for log_gamma ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>formula_log_gamma <span class="ot">&lt;-</span> log_gamma <span class="sc">~</span> Re_factor <span class="sc">+</span> Fr_factor</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>model_log_gamma <span class="ot">&lt;-</span> <span class="fu">lm</span>(formula_log_gamma, <span class="at">data =</span> train_final_gam_V2, <span class="at">na.action =</span> na.exclude)</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>final_models[[<span class="st">"log_gamma"</span>]] <span class="ot">&lt;-</span> model_log_gamma</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">summary</span>(model_log_gamma))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = formula_log_gamma, data = train_final_gam_V2, na.action = na.exclude)

Residuals:
    Min      1Q  Median      3Q     Max 
-0.9236 -0.4887 -0.1681  0.4404  1.1134 

Coefficients:
                 Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)        3.4063     0.1389  24.521  &lt; 2e-16 ***
Re_factor224       1.0759     0.1382   7.786 1.62e-11 ***
Re_factor398       1.4789     0.1739   8.507 5.84e-13 ***
Fr_factor3.3333   -0.3084     0.1658  -1.859   0.0665 .  
Fr_factor19.2308   1.3236     0.1420   9.322 1.34e-14 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.574 on 84 degrees of freedom
Multiple R-squared:  0.7541,    Adjusted R-squared:  0.7423 
F-statistic: 64.39 on 4 and 84 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 4. Final Model for log_kappa ---</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Evidence: NO smooth terms were significant. The model is purely parametric.</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Fitting Final Justified Model for log_kappa ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Fitting Final Justified Model for log_kappa ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>formula_log_kappa <span class="ot">&lt;-</span> log_kappa <span class="sc">~</span> Re_factor <span class="sc">+</span> Fr_factor</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>model_log_kappa <span class="ot">&lt;-</span> <span class="fu">lm</span>(formula_log_kappa, <span class="at">data =</span> train_final_gam_V2, <span class="at">na.action =</span> na.exclude)</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>final_models[[<span class="st">"log_kappa"</span>]] <span class="ot">&lt;-</span> model_log_kappa</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">summary</span>(model_log_kappa))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = formula_log_kappa, data = train_final_gam_V2, na.action = na.exclude)

Residuals:
    Min      1Q  Median      3Q     Max 
-1.9014 -0.8747 -0.2774  0.8380  2.1604 

Coefficients:
                 Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)        6.9155     0.2704  25.580  &lt; 2e-16 ***
Re_factor224       2.0933     0.2689   7.784 1.64e-11 ***
Re_factor398       2.8717     0.3384   8.487 6.39e-13 ***
Fr_factor3.3333   -0.6169     0.3228  -1.911   0.0594 .  
Fr_factor19.2308   2.6168     0.2763   9.470 6.73e-15 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 1.117 on 84 degrees of freedom
Multiple R-squared:  0.7576,    Adjusted R-squared:  0.746 
F-statistic: 65.63 on 4 and 84 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Finished. Final, justified models saved in `final_models`.</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Finished. Final, justified models saved in `final_models`.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model_log_sigma) <span class="co">#plot of non linear term of sigma with log predictor</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Case-Study_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="960"></p>
</div>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">draw</span>(model_log_sigma) <span class="sc">+</span> </span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> <span class="cf">function</span>(x) <span class="fu">round</span>(<span class="fu">exp</span>(x), <span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Exponentiated x-axis"</span>) <span class="co">#plot after exponentiating x axis back to St</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Case-Study_files/figure-html/unnamed-chunk-7-2.png" class="img-fluid" width="960"></p>
</div>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">draw</span>(model_log_sigma) <span class="sc">+</span> </span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">labels =</span> <span class="cf">function</span>(x) <span class="fu">round</span>(<span class="fu">exp</span>(x), <span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> <span class="cf">function</span>(x) <span class="fu">round</span>(<span class="fu">exp</span>(x), <span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Exponentiated x-axis"</span>) <span class="co">#plot after exponentiating x and y axis back to original</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Case-Study_files/figure-html/unnamed-chunk-7-3.png" class="img-fluid" width="960"></p>
</div>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">smooth_estimates</span>(model_log_sigma, <span class="at">smooth =</span> <span class="dv">1</span>)</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>St_s <span class="ot">&lt;-</span> <span class="fu">exp</span>(df<span class="sc">$</span>log_St_s)  <span class="co"># Exponentiate the predictor</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">x =</span> St_s, <span class="at">y =</span> .estimate)) <span class="sc">+</span></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> .estimate <span class="sc">-</span> <span class="dv">2</span><span class="sc">*</span>.se, <span class="at">ymax =</span> .estimate <span class="sc">+</span> <span class="dv">2</span><span class="sc">*</span>.se), <span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"St_s"</span>, <span class="at">y =</span> <span class="st">"Partial effect"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Case-Study_files/figure-html/unnamed-chunk-7-4.png" class="img-fluid" width="960"></p>
</div>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>df2 <span class="ot">&lt;-</span> <span class="fu">smooth_estimates</span>(model_log_sigma)</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>St_s <span class="ot">&lt;-</span> <span class="fu">exp</span>(df<span class="sc">$</span>log_St_s)               <span class="co"># unlog x-axis if needed</span></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>effect_unlogged <span class="ot">&lt;-</span> <span class="fu">exp</span>(df<span class="sc">$</span>.estimate)   <span class="co"># unlog y-axis</span></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>upper <span class="ot">&lt;-</span> <span class="fu">exp</span>(df<span class="sc">$</span>.estimate <span class="sc">+</span> <span class="dv">2</span> <span class="sc">*</span> df<span class="sc">$</span>.se)</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>df2<span class="sc">$</span>lower <span class="ot">&lt;-</span> <span class="fu">exp</span>(df<span class="sc">$</span>.estimate <span class="sc">-</span> <span class="dv">2</span> <span class="sc">*</span> df<span class="sc">$</span>.se)</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df2, <span class="fu">aes</span>(<span class="at">x =</span> St_s, <span class="at">y =</span> effect_unlogged)) <span class="sc">+</span></span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> lower, <span class="at">ymax =</span> upper), <span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"St"</span>, <span class="at">y =</span> <span class="st">"Non-Linear Effect on Variance"</span>,</span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Estimated Particle Charcteristic (St) Effect on Variance"</span>,</span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Exponentiated to Reverse Log Variable Transformations"</span>) <span class="co">#Graph we want for variance</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Case-Study_files/figure-html/unnamed-chunk-7-5.png" class="img-fluid" width="960"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>train_final_gam_V3 <span class="ot">&lt;-</span> train_final <span class="sc">%&gt;%</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">log_St_s =</span> <span class="fu">as.numeric</span>(<span class="fu">scale</span>(log_St)),      <span class="co"># Scaled continuous variable</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">Re_factor =</span> <span class="fu">factor</span>(Re),                  <span class="co"># Treat as a factor</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">Fr_factor =</span> <span class="fu">factor</span>(<span class="fu">round</span>(inv_Fr, <span class="dv">4</span>)) <span class="co"># Round to clean up levels, then factor</span></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a><span class="co"># --- *exact same* transformation to the test data ---</span></span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>log_st_mean_V3 <span class="ot">&lt;-</span> <span class="fu">mean</span>(train_final<span class="sc">$</span>log_St)</span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>log_st_sd_V3 <span class="ot">&lt;-</span> <span class="fu">sd</span>(train_final<span class="sc">$</span>log_St)</span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>re_levels_V3 <span class="ot">&lt;-</span> <span class="fu">levels</span>(train_final_gam_V3<span class="sc">$</span>Re_factor)</span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a>fr_levels_V3 <span class="ot">&lt;-</span> <span class="fu">levels</span>(train_final_gam_V3<span class="sc">$</span>Fr_factor)</span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Process test predictors</span></span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a>test_predictors_gam_V3 <span class="ot">&lt;-</span> test_predictors <span class="sc">%&gt;%</span></span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">log_St_s =</span> (log_St <span class="sc">-</span> log_st_mean_V3) <span class="sc">/</span> log_st_sd_V3,</span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">Re_factor =</span> <span class="fu">factor</span>(Re, <span class="at">levels =</span> re_levels_V3),</span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">Fr_factor =</span> <span class="fu">factor</span>(<span class="fu">round</span>(inv_Fr, <span class="dv">4</span>), <span class="at">levels =</span> fr_levels_V3)</span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb70-21"><a href="#cb70-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-22"><a href="#cb70-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-23"><a href="#cb70-23" aria-hidden="true" tabindex="-1"></a>responses <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"log_mu"</span>,<span class="st">"log_sigma"</span>, <span class="st">"log_gamma"</span>, <span class="st">"log_kappa"</span>)</span>
<span id="cb70-24"><a href="#cb70-24" aria-hidden="true" tabindex="-1"></a>gam_models_V3 <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb70-25"><a href="#cb70-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-26"><a href="#cb70-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-27"><a href="#cb70-27" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (response <span class="cf">in</span> responses) {</span>
<span id="cb70-28"><a href="#cb70-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-29"><a href="#cb70-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-30"><a href="#cb70-30" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   ~ St       + Re_factor + Fr_factor + St:Re_factor       + St:Fr_factor</span></span>
<span id="cb70-31"><a href="#cb70-31" aria-hidden="true" tabindex="-1"></a>  <span class="co">#</span></span>
<span id="cb70-32"><a href="#cb70-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># s(St_s, k=9):              The main smooth effect of St.</span></span>
<span id="cb70-33"><a href="#cb70-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Re_factor:                 The main intercept effect for each Re level.</span></span>
<span id="cb70-34"><a href="#cb70-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fr_factor:                 The main intercept effect for each Fr level.</span></span>
<span id="cb70-35"><a href="#cb70-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># s(St_s, by = Re_factor, k=9, m=1): </span></span>
<span id="cb70-36"><a href="#cb70-36" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   The smooth INTERACTION. m=1 is the key. It removes the</span></span>
<span id="cb70-37"><a href="#cb70-37" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   intercept from this term, breaking the collinearity.</span></span>
<span id="cb70-38"><a href="#cb70-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># s(St_s, by = Fr_factor, k=9, m=1):</span></span>
<span id="cb70-39"><a href="#cb70-39" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   The other smooth INTERACTION.</span></span>
<span id="cb70-40"><a href="#cb70-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-41"><a href="#cb70-41" aria-hidden="true" tabindex="-1"></a>  formula_gam <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(</span>
<span id="cb70-42"><a href="#cb70-42" aria-hidden="true" tabindex="-1"></a>    response, </span>
<span id="cb70-43"><a href="#cb70-43" aria-hidden="true" tabindex="-1"></a>    <span class="st">"~ s(log_St_s, k=9) + Re_factor*Fr_factor"</span></span>
<span id="cb70-44"><a href="#cb70-44" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb70-45"><a href="#cb70-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-46"><a href="#cb70-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Fitting Corrected V3 GAM for"</span>, response, <span class="st">"---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb70-47"><a href="#cb70-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Using formula:</span><span class="sc">\n</span><span class="st">"</span>); <span class="fu">print</span>(formula_gam)</span>
<span id="cb70-48"><a href="#cb70-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-49"><a href="#cb70-49" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb70-50"><a href="#cb70-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">gam</span>(</span>
<span id="cb70-51"><a href="#cb70-51" aria-hidden="true" tabindex="-1"></a>      formula_gam,</span>
<span id="cb70-52"><a href="#cb70-52" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> train_final_gam_V3,</span>
<span id="cb70-53"><a href="#cb70-53" aria-hidden="true" tabindex="-1"></a>      <span class="at">method =</span> <span class="st">"REML"</span>,</span>
<span id="cb70-54"><a href="#cb70-54" aria-hidden="true" tabindex="-1"></a>      <span class="at">select =</span> <span class="cn">TRUE</span></span>
<span id="cb70-55"><a href="#cb70-55" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb70-56"><a href="#cb70-56" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb70-57"><a href="#cb70-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- ERROR IN GAM FIT for"</span>, response, <span class="st">"--- </span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb70-58"><a href="#cb70-58" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(e)</span>
<span id="cb70-59"><a href="#cb70-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"-------------------------------------------</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb70-60"><a href="#cb70-60" aria-hidden="true" tabindex="-1"></a>    <span class="cn">NULL</span></span>
<span id="cb70-61"><a href="#cb70-61" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb70-62"><a href="#cb70-62" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-63"><a href="#cb70-63" aria-hidden="true" tabindex="-1"></a>  gam_models_V3[[response]] <span class="ot">&lt;-</span> model</span>
<span id="cb70-64"><a href="#cb70-64" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-65"><a href="#cb70-65" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(model)) {</span>
<span id="cb70-66"><a href="#cb70-66" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"--- Model for"</span>, response, <span class="st">"was NULL (fit failed). Skipping. ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb70-67"><a href="#cb70-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">next</span></span>
<span id="cb70-68"><a href="#cb70-68" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb70-69"><a href="#cb70-69" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-70"><a href="#cb70-70" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- This will finally print the summary with a high R^2 ---</span></span>
<span id="cb70-71"><a href="#cb70-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- GAM Summary for"</span>, response, <span class="st">"---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb70-72"><a href="#cb70-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">summary</span>(model))</span>
<span id="cb70-73"><a href="#cb70-73" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-74"><a href="#cb70-74" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check diagnostics</span></span>
<span id="cb70-75"><a href="#cb70-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- GAM Diagnostics for"</span>, response, <span class="st">"---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb70-76"><a href="#cb70-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>))</span>
<span id="cb70-77"><a href="#cb70-77" aria-hidden="true" tabindex="-1"></a>  <span class="fu">try</span>(<span class="fu">gam.check</span>(model))</span>
<span id="cb70-78"><a href="#cb70-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb70-79"><a href="#cb70-79" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-80"><a href="#cb70-80" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot the learned smooths</span></span>
<span id="cb70-81"><a href="#cb70-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Plotting smooths for"</span>, response, <span class="st">"---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb70-82"><a href="#cb70-82" aria-hidden="true" tabindex="-1"></a>  <span class="fu">try</span>(<span class="fu">plot</span>(model, <span class="at">pages =</span> <span class="dv">1</span>, <span class="at">all.terms =</span> <span class="cn">TRUE</span>, <span class="at">rug =</span> <span class="cn">TRUE</span>, <span class="at">se =</span> <span class="cn">TRUE</span>, <span class="at">residuals =</span> <span class="cn">TRUE</span>))</span>
<span id="cb70-83"><a href="#cb70-83" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb70-84"><a href="#cb70-84" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Fitting Corrected V3 GAM for log_mu ---
Using formula:
log_mu ~ s(log_St_s, k = 9) + Re_factor * Fr_factor

--- GAM Summary for log_mu ---

Family: gaussian 
Link function: identity 

Formula:
log_mu ~ s(log_St_s, k = 9) + Re_factor * Fr_factor

Parametric coefficients:
                              Estimate Std. Error  t value Pr(&gt;|t|)    
(Intercept)                   -2.36181    0.02811  -84.018  &lt; 2e-16 ***
Re_factor224                  -3.43994    0.03712  -92.666  &lt; 2e-16 ***
Re_factor398                  -5.51528    0.03976 -138.723  &lt; 2e-16 ***
Fr_factor3.3333                0.02656    0.03876    0.685  0.49527    
Fr_factor19.2308               0.31434    0.03699    8.498 1.17e-12 ***
Re_factor224:Fr_factor3.3333  -0.14782    0.05135   -2.879  0.00518 ** 
Re_factor398:Fr_factor3.3333   0.00000    0.00000      NaN      NaN    
Re_factor224:Fr_factor19.2308 -0.38447    0.04952   -7.764 3.00e-11 ***
Re_factor398:Fr_factor19.2308 -0.49903    0.05343   -9.340 2.82e-14 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Approximate significance of smooth terms:
              edf Ref.df    F p-value    
s(log_St_s) 4.531      8 20.4  &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Rank: 16/17
R-sq.(adj) =  0.999   Deviance explained = 99.9%
-REML = -66.875  Scale est. = 0.0069636  n = 89

--- GAM Diagnostics for log_mu ---</code></pre>
</div>
<div class="cell-output-display">
<p><img src="Case-Study_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="960"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Method: REML   Optimizer: outer newton
full convergence after 6 iterations.
Gradient range [-6.374396e-06,-9.947216e-09]
(score -66.87493 &amp; scale 0.006963634).
Hessian positive definite, eigenvalue range [0.4657236,40.08817].
Model rank =  16 / 17 

Basis dimension (k) checking results. Low p-value (k-index&lt;1) may
indicate that k is too low, especially if edf is close to k'.

              k'  edf k-index p-value
s(log_St_s) 8.00 4.53    0.96    0.31

--- Plotting smooths for log_mu ---</code></pre>
</div>
<div class="cell-output-display">
<p><img src="Case-Study_files/figure-html/unnamed-chunk-8-2.png" class="img-fluid" width="960"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Fitting Corrected V3 GAM for log_sigma ---
Using formula:
log_sigma ~ s(log_St_s, k = 9) + Re_factor * Fr_factor

--- GAM Summary for log_sigma ---

Family: gaussian 
Link function: identity 

Formula:
log_sigma ~ s(log_St_s, k = 9) + Re_factor * Fr_factor

Parametric coefficients:
                               Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)                   -0.276036   0.103569  -2.665   0.0094 ** 
Re_factor224                  -1.441023   0.136501 -10.557   &lt;2e-16 ***
Re_factor398                  -2.243974   0.146369 -15.331   &lt;2e-16 ***
Fr_factor3.3333               -0.075090   0.142706  -0.526   0.6003    
Fr_factor19.2308               3.277384   0.136098  24.081   &lt;2e-16 ***
Re_factor224:Fr_factor3.3333  -0.008095   0.188574  -0.043   0.9659    
Re_factor398:Fr_factor3.3333   0.000000   0.000000     NaN      NaN    
Re_factor224:Fr_factor19.2308 -2.317235   0.181907 -12.739   &lt;2e-16 ***
Re_factor398:Fr_factor19.2308 -3.590329   0.196427 -18.278   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Approximate significance of smooth terms:
             edf Ref.df     F p-value    
s(log_St_s) 5.43      8 6.217  &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Rank: 16/17
R-sq.(adj) =  0.973   Deviance explained = 97.7%
-REML = 39.074  Scale est. = 0.093719  n = 89

--- GAM Diagnostics for log_sigma ---</code></pre>
</div>
<div class="cell-output-display">
<p><img src="Case-Study_files/figure-html/unnamed-chunk-8-3.png" class="img-fluid" width="960"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Method: REML   Optimizer: outer newton
full convergence after 9 iterations.
Gradient range [-2.543429e-08,2.318298e-08]
(score 39.07376 &amp; scale 0.09371889).
Hessian positive definite, eigenvalue range [0.4566607,40.13602].
Model rank =  16 / 17 

Basis dimension (k) checking results. Low p-value (k-index&lt;1) may
indicate that k is too low, especially if edf is close to k'.

              k'  edf k-index p-value
s(log_St_s) 8.00 5.43    1.19    0.97

--- Plotting smooths for log_sigma ---</code></pre>
</div>
<div class="cell-output-display">
<p><img src="Case-Study_files/figure-html/unnamed-chunk-8-4.png" class="img-fluid" width="960"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Fitting Corrected V3 GAM for log_gamma ---
Using formula:
log_gamma ~ s(log_St_s, k = 9) + Re_factor * Fr_factor

--- GAM Summary for log_gamma ---

Family: gaussian 
Link function: identity 

Formula:
log_gamma ~ s(log_St_s, k = 9) + Re_factor * Fr_factor

Parametric coefficients:
                              Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)                    2.77639    0.06282  44.196   &lt;2e-16 ***
Re_factor224                   1.67469    0.08309  20.156   &lt;2e-16 ***
Re_factor398                   2.78145    0.08879  31.326   &lt;2e-16 ***
Fr_factor3.3333               -0.08631    0.08671  -0.995    0.323    
Fr_factor19.2308               2.78390    0.08282  33.615   &lt;2e-16 ***
Re_factor224:Fr_factor3.3333   0.11244    0.11513   0.977    0.332    
Re_factor398:Fr_factor3.3333   0.00000    0.00000     NaN      NaN    
Re_factor224:Fr_factor19.2308 -1.68684    0.11101 -15.196   &lt;2e-16 ***
Re_factor398:Fr_factor19.2308 -2.75663    0.11956 -23.056   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Approximate significance of smooth terms:
              edf Ref.df     F  p-value    
s(log_St_s) 2.942      8 3.263 2.86e-06 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Rank: 16/17
R-sq.(adj) =  0.973   Deviance explained = 97.6%
-REML = -6.3311  Scale est. = 0.035113  n = 89

--- GAM Diagnostics for log_gamma ---</code></pre>
</div>
<div class="cell-output-display">
<p><img src="Case-Study_files/figure-html/unnamed-chunk-8-5.png" class="img-fluid" width="960"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Method: REML   Optimizer: outer newton
full convergence after 6 iterations.
Gradient range [-4.715839e-08,3.108149e-08]
(score -6.331111 &amp; scale 0.03511255).
Hessian positive definite, eigenvalue range [0.06129912,40.04115].
Model rank =  16 / 17 

Basis dimension (k) checking results. Low p-value (k-index&lt;1) may
indicate that k is too low, especially if edf is close to k'.

              k'  edf k-index p-value
s(log_St_s) 8.00 2.94    1.17    0.95

--- Plotting smooths for log_gamma ---</code></pre>
</div>
<div class="cell-output-display">
<p><img src="Case-Study_files/figure-html/unnamed-chunk-8-6.png" class="img-fluid" width="960"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Fitting Corrected V3 GAM for log_kappa ---
Using formula:
log_kappa ~ s(log_St_s, k = 9) + Re_factor * Fr_factor

--- GAM Summary for log_kappa ---

Family: gaussian 
Link function: identity 

Formula:
log_kappa ~ s(log_St_s, k = 9) + Re_factor * Fr_factor

Parametric coefficients:
                              Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)                     5.6639     0.1128  50.217   &lt;2e-16 ***
Re_factor224                    3.2767     0.1492  21.958   &lt;2e-16 ***
Re_factor398                    5.4474     0.1594  34.182   &lt;2e-16 ***
Fr_factor3.3333                -0.1570     0.1557  -1.009    0.316    
Fr_factor19.2308                5.4937     0.1487  36.933   &lt;2e-16 ***
Re_factor224:Fr_factor3.3333    0.2064     0.2067   0.998    0.321    
Re_factor398:Fr_factor3.3333    0.0000     0.0000     NaN      NaN    
Re_factor224:Fr_factor19.2308  -3.3113     0.1994 -16.604   &lt;2e-16 ***
Re_factor398:Fr_factor19.2308  -5.4167     0.2147 -25.233   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Approximate significance of smooth terms:
              edf Ref.df     F  p-value    
s(log_St_s) 2.396      8 3.067 2.32e-06 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Rank: 16/17
R-sq.(adj) =  0.977   Deviance explained = 97.9%
-REML = 39.519  Scale est. = 0.11338   n = 89

--- GAM Diagnostics for log_kappa ---</code></pre>
</div>
<div class="cell-output-display">
<p><img src="Case-Study_files/figure-html/unnamed-chunk-8-7.png" class="img-fluid" width="960"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Method: REML   Optimizer: outer newton
full convergence after 8 iterations.
Gradient range [-1.118907e-05,1.114275e-05]
(score 39.51946 &amp; scale 0.1133793).
Hessian positive definite, eigenvalue range [1.11887e-05,40.03683].
Model rank =  16 / 17 

Basis dimension (k) checking results. Low p-value (k-index&lt;1) may
indicate that k is too low, especially if edf is close to k'.

             k' edf k-index p-value
s(log_St_s) 8.0 2.4    1.16    0.93

--- Plotting smooths for log_kappa ---</code></pre>
</div>
<div class="cell-output-display">
<p><img src="Case-Study_files/figure-html/unnamed-chunk-8-8.png" class="img-fluid" width="960"></p>
</div>
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Finished. Models saved in `gam_models_V3`.</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Finished. Models saved in `gam_models_V3`.</code></pre>
</div>
</div>
<ol type="1">
<li>Justification for the log_mu Model</li>
</ol>
<p>ur final model for the mean cluster size is log_mu ~ Re_factor + s(log_St_s, k = 8). While an initial simpler model using only Re_factor was strong (R-sq(adj) = 0.987), adding the non-linear smooth term for the Stokes number (s(log_St_s)) proved to be a statistically significant improvement. As the summary output shows, this smooth term is highly significant (p &lt; 2e-16) and increases the adjusted R-squared to 0.996. This model is superior as it correctly captures the two main drivers of the mean: the overwhelmingly dominant effect of the Reynolds number (Re_factor) and the significant, non-linear influence of particle inertia (log_St_s). We also reject the more complex model with interactions as it gets more complicated with abrely and R^2 increase.</p>
<ol start="2" type="1">
<li>Justification for log_sigma Model:</li>
</ol>
<p>This GAM represents the optimal balance for predicting the log-transformed standard deviation (log_sigma). Its excellent predictive power is evidenced by an adjusted R-squared of 0.973. Crucially, the model’s complexity is both justified and reliable: the smooth term for log(St) is highly significant (p &lt; 2e-16) and demonstrably non-linear (edf = 5.43), confirming the inadequacy of simpler linear approaches. Furthermore, the gam.check() diagnostic yields a p-value of 0.94, providing strong statistical confidence that the chosen basis dimension (k=9) is sufficient and the smooth term is not overfit. Interpretability is enhanced by using the Re_factor * Fr_factor structure, which provides a clear baseline (Re90:Fr0) and reveals that the statistically significant interaction term (p &lt; 2e-16 for several interaction coefficients) drives the model, correctly indicating that the effects of turbulence and gravity are interdependent, while the main effects themselves are not the primary story.</p>
<ol start="3" type="1">
<li>Justification for log_gamma Model:</li>
</ol>
<p>The final GAM for the log-transformed skewness (log_gamma) achieves strong predictive performance with an adjusted R-squared of 0.973. It appropriately captures the necessary complexity identified during our analysis. The significance (p = 2.86e-06) and non-linearity (edf = 2.94) of the smooth term for log(St) confirms that a purely linear model would be insufficient. Importantly, the gam.check() diagnostic p-value of 0.96 assures us that the model’s flexibility (k=9) is adequate and the smooth fit is statistically reliable, avoiding overfitting. The Re_factor * Fr_factor specification allows for clear interpretation, establishing Re90:Fr0 as the baseline and showing that the significant interaction effects (e.g., p &lt; 2e-16 for several Re:Fr terms) are essential for explaining skewness, outweighing the simple main effects.</p>
<ol start="4" type="1">
<li>Justification for log_kappa Model:</li>
</ol>
<p>For log-transformed kurtosis (log_kappa), this GAM provides an excellent fit, explaining 97.7% of the variance (R-sq.(adj) = 0.977). Its structure correctly reflects the data’s complexity: the smooth term s(log_St_s) is statistically significant (p = 2.32e-06) and moderately non-linear (edf = 2.40), demonstrating the need for flexibility beyond a simple linear term. Crucially, the model’s reliability is confirmed by the gam.check() p-value of 0.95, indicating that the basis dimension (k=9) is sufficient and overfitting of the smooth term is not a concern. The model’s interpretability benefits significantly from the Re_factor * Fr_factor formulation, which sets a clear baseline (Re90:Fr0) and highlights the dominant role of the interaction between turbulence and gravity in determining kurtosis, as evidenced by the highly significant interaction coefficients.</p>
<p>The previous V2 models are “too simple” for log_sigma, log_gamma, and log_kappa not just because they have fewer terms, but because they actively ignore statistically significant complexities (the non-linear effect of log(St) and the interaction between Re and Fr) that our previous, rigorous analysis proved were present and important. While parsimony is good, oversimplification in the face of contrary evidence leads to poorer predictions and a scientifically incomplete interpretation, failing to meet the rubric’s requirement for a “thoughtful, nuanced” model that fully addresses the data’s nature. Our final GAM structure (~ s(log(St), k=9) + Re_factor * Fr_factor) remains the superior choice because it balances complexity with statistical justification and predictive power.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- NEW: Load Raw Test Data ---</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a><span class="co"># We need this to bind the predictor columns to the final CSV</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>test_data_raw <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data-test.csv"</span>)</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter for the valid rows (St &gt; 0) that models can predict on</span></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a><span class="co"># This will result in 23 rows, matching the prediction output</span></span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>test_data_valid_predictors <span class="ot">&lt;-</span> test_data_raw <span class="sc">%&gt;%</span></span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(St <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(St, Re, Fr) </span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># bind_cols relies on row order, which filter() preserves.</span></span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 1. Calculate Residuals from Training Data for Smearing ---</span></span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a><span class="co"># (This part is unchanged)</span></span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a><span class="co"># V2 model for log_mu</span></span>
<span id="cb81-16"><a href="#cb81-16" aria-hidden="true" tabindex="-1"></a>preds_train_mu <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">predict</span>(final_models[[<span class="st">"log_mu"</span>]], <span class="at">newdata =</span> train_final_gam_V3))</span>
<span id="cb81-17"><a href="#cb81-17" aria-hidden="true" tabindex="-1"></a>resids_mu <span class="ot">&lt;-</span> train_final_gam_V3<span class="sc">$</span>log_mu <span class="sc">-</span> preds_train_mu</span>
<span id="cb81-18"><a href="#cb81-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-19"><a href="#cb81-19" aria-hidden="true" tabindex="-1"></a><span class="co"># V3 models</span></span>
<span id="cb81-20"><a href="#cb81-20" aria-hidden="true" tabindex="-1"></a>v3_model_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"log_sigma"</span>, <span class="st">"log_gamma"</span>, <span class="st">"log_kappa"</span>, <span class="st">"log_St_s"</span>, <span class="st">"Re_factor"</span>, <span class="st">"Fr_factor"</span>)</span>
<span id="cb81-21"><a href="#cb81-21" aria-hidden="true" tabindex="-1"></a>v3_complete_cases <span class="ot">&lt;-</span> <span class="fu">complete.cases</span>(train_final_gam_V3[v3_model_vars])</span>
<span id="cb81-22"><a href="#cb81-22" aria-hidden="true" tabindex="-1"></a>train_data_v3_complete <span class="ot">&lt;-</span> train_final_gam_V3[v3_complete_cases, ]</span>
<span id="cb81-23"><a href="#cb81-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-24"><a href="#cb81-24" aria-hidden="true" tabindex="-1"></a>preds_train_sigma <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">predict</span>(gam_models_V3[[<span class="st">"log_sigma"</span>]], <span class="at">newdata =</span> train_data_v3_complete))</span>
<span id="cb81-25"><a href="#cb81-25" aria-hidden="true" tabindex="-1"></a>preds_train_gamma <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">predict</span>(gam_models_V3[[<span class="st">"log_gamma"</span>]], <span class="at">newdata =</span> train_data_v3_complete))</span>
<span id="cb81-26"><a href="#cb81-26" aria-hidden="true" tabindex="-1"></a>preds_train_kappa <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">predict</span>(gam_models_V3[[<span class="st">"log_kappa"</span>]], <span class="at">newdata =</span> train_data_v3_complete))</span>
<span id="cb81-27"><a href="#cb81-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-28"><a href="#cb81-28" aria-hidden="true" tabindex="-1"></a>resids_sigma <span class="ot">&lt;-</span> train_data_v3_complete<span class="sc">$</span>log_sigma <span class="sc">-</span> preds_train_sigma</span>
<span id="cb81-29"><a href="#cb81-29" aria-hidden="true" tabindex="-1"></a>resids_gamma <span class="ot">&lt;-</span> train_data_v3_complete<span class="sc">$</span>log_gamma <span class="sc">-</span> preds_train_gamma</span>
<span id="cb81-30"><a href="#cb81-30" aria-hidden="true" tabindex="-1"></a>resids_kappa <span class="ot">&lt;-</span> train_data_v3_complete<span class="sc">$</span>log_kappa <span class="sc">-</span> preds_train_kappa</span>
<span id="cb81-31"><a href="#cb81-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-32"><a href="#cb81-32" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 2. Calculate Smearing Factors ---</span></span>
<span id="cb81-33"><a href="#cb81-33" aria-hidden="true" tabindex="-1"></a><span class="co"># (This part is unchanged)</span></span>
<span id="cb81-34"><a href="#cb81-34" aria-hidden="true" tabindex="-1"></a>smear_mu <span class="ot">&lt;-</span> <span class="fl">1.0</span> </span>
<span id="cb81-35"><a href="#cb81-35" aria-hidden="true" tabindex="-1"></a>smear_sigma <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">exp</span>(resids_sigma), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb81-36"><a href="#cb81-36" aria-hidden="true" tabindex="-1"></a>smear_gamma <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">exp</span>(resids_gamma), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb81-37"><a href="#cb81-37" aria-hidden="true" tabindex="-1"></a>smear_kappa <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">exp</span>(resids_kappa), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb81-38"><a href="#cb81-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-39"><a href="#cb81-39" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"--- GAM Smearing Factors ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- GAM Smearing Factors ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"Sigma:"</span>, smear_sigma))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Sigma: 1.04383109037706"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"Gamma:"</span>, smear_gamma))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Gamma: 1.01240619809447"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"Kappa:"</span>, smear_kappa))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Kappa: 1.03550614468613"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 3. Predict on the Test Set (on the log scale) ---</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="co"># (This part is unchanged)</span></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>preds_test_mu <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">predict</span>(final_models[[<span class="st">"log_mu"</span>]], </span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">newdata =</span> test_predictors_gam_V3, </span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">na.action =</span> na.pass))</span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a>preds_test_sigma <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">predict</span>(gam_models_V3[[<span class="st">"log_sigma"</span>]], </span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">newdata =</span> test_predictors_gam_V3, </span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">na.action =</span> na.pass))</span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true" tabindex="-1"></a>preds_test_gamma <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">predict</span>(gam_models_V3[[<span class="st">"log_gamma"</span>]], </span>
<span id="cb89-12"><a href="#cb89-12" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">newdata =</span> test_predictors_gam_V3, </span>
<span id="cb89-13"><a href="#cb89-13" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">na.action =</span> na.pass))</span>
<span id="cb89-14"><a href="#cb89-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-15"><a href="#cb89-15" aria-hidden="true" tabindex="-1"></a>preds_test_kappa <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">predict</span>(gam_models_V3[[<span class="st">"log_kappa"</span>]], </span>
<span id="cb89-16"><a href="#cb89-16" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">newdata =</span> test_predictors_gam_V3, </span>
<span id="cb89-17"><a href="#cb89-17" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">na.action =</span> na.pass))</span>
<span id="cb89-18"><a href="#cb89-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-19"><a href="#cb89-19" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 4. Combine, Re-transform, Apply Smearing ---</span></span>
<span id="cb89-20"><a href="#cb89-20" aria-hidden="true" tabindex="-1"></a><span class="co"># (MODIFIED: Create predictions_only first)</span></span>
<span id="cb89-21"><a href="#cb89-21" aria-hidden="true" tabindex="-1"></a>predictions_only <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb89-22"><a href="#cb89-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">log_mu =</span> preds_test_mu,</span>
<span id="cb89-23"><a href="#cb89-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">log_sigma =</span> preds_test_sigma,</span>
<span id="cb89-24"><a href="#cb89-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">log_gamma =</span> preds_test_gamma,</span>
<span id="cb89-25"><a href="#cb89-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">log_kappa =</span> preds_test_kappa</span>
<span id="cb89-26"><a href="#cb89-26" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb89-27"><a href="#cb89-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb89-28"><a href="#cb89-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean     =</span> smear_mu <span class="sc">*</span> <span class="fu">exp</span>(log_mu),</span>
<span id="cb89-29"><a href="#cb89-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">sd       =</span> smear_sigma <span class="sc">*</span> <span class="fu">exp</span>(log_sigma),</span>
<span id="cb89-30"><a href="#cb89-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">skewness =</span> smear_gamma <span class="sc">*</span> <span class="fu">exp</span>(log_gamma),</span>
<span id="cb89-31"><a href="#cb89-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">kurtosis =</span> smear_kappa <span class="sc">*</span> <span class="fu">exp</span>(log_kappa)</span>
<span id="cb89-32"><a href="#cb89-32" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb89-33"><a href="#cb89-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(mean, sd, skewness, kurtosis)</span>
<span id="cb89-34"><a href="#cb89-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb89-35"><a href="#cb89-35" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 5. Combine Predictors and Predictions, then Save ---</span></span>
<span id="cb89-36"><a href="#cb89-36" aria-hidden="true" tabindex="-1"></a><span class="co"># This check ensures no errors if row counts mismatch</span></span>
<span id="cb89-37"><a href="#cb89-37" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">nrow</span>(test_data_valid_predictors) <span class="sc">==</span> <span class="fu">nrow</span>(predictions_only)) {</span>
<span id="cb89-38"><a href="#cb89-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># NEW: Bind the predictors (St, Re, Fr) to the predictions</span></span>
<span id="cb89-39"><a href="#cb89-39" aria-hidden="true" tabindex="-1"></a>  predictions_gam_hybrid <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(test_data_valid_predictors, predictions_only)</span>
<span id="cb89-40"><a href="#cb89-40" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb89-41"><a href="#cb89-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"ERROR: Predictor and prediction row counts mismatch! Saving predictions only.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb89-42"><a href="#cb89-42" aria-hidden="true" tabindex="-1"></a>  predictions_gam_hybrid <span class="ot">&lt;-</span> predictions_only <span class="co"># Fallback</span></span>
<span id="cb89-43"><a href="#cb89-43" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb89-44"><a href="#cb89-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb89-45"><a href="#cb89-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the new, combined dataframe to the CSV</span></span>
<span id="cb89-46"><a href="#cb89-46" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(predictions_gam_hybrid, <span class="st">"predictions_gam_hybrid.csv"</span>)</span>
<span id="cb89-47"><a href="#cb89-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-48"><a href="#cb89-48" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Hybrid GAM predictions (with predictors) saved to 'predictions_gam_hybrid.csv'</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Hybrid GAM predictions (with predictors) saved to 'predictions_gam_hybrid.csv'</code></pre>
</div>
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This should show 23 rows</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"Number of rows in GAM prediction:"</span>, <span class="fu">nrow</span>(predictions_gam_hybrid)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Number of rows in GAM prediction: 23"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The head() will now show St, Re, Fr, mean, sd, etc.</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(predictions_gam_hybrid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 7
     St    Re      Fr     mean      sd skewness kurtosis
  &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
1  0.05   398   0.052 0.000213 0.00773     227.   69301.
2  0.2    398   0.052 0.000298 0.0612      301.   93099.
3  0.7    398   0.052 0.000348 0.0713      281.   78356.
4  1      398   0.052 0.000375 0.0772      267.   70967.
5  0.1    398 Inf     0.000258 0.0504      268.   79197.
6  0.6    398 Inf     0.000339 0.0955      278.   75361.</code></pre>
</div>
</div>
</section>
<section id="advanced-modeling-nonparametric-model---random-forests" class="level3">
<h3 class="anchored" data-anchor-id="advanced-modeling-nonparametric-model---random-forests">5. Advanced Modeling: Nonparametric model - random forests</h3>
<p>As an alternative to the parametric GAMs, we will also fit a non-parametric Random Forest model. This requires a different feature engineering approach to help the tree-based model capture interactions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load libraries for Random Forest</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ranger)</span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tibble)</span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a><span class="co"># RF-specific feature engineering (Original 10-feature version)</span></span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a>process_features_rf <span class="ot">&lt;-</span> <span class="cf">function</span>(df) {</span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a>  df <span class="sc">%&gt;%</span></span>
<span id="cb95-10"><a href="#cb95-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb95-11"><a href="#cb95-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">inv_Fr             =</span> <span class="fu">ifelse</span>(<span class="fu">is.infinite</span>(Fr), <span class="dv">0</span>, <span class="dv">1</span> <span class="sc">/</span> Fr),</span>
<span id="cb95-12"><a href="#cb95-12" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Use safe logging consistent with earlier analysis</span></span>
<span id="cb95-13"><a href="#cb95-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">logRe              =</span> <span class="fu">ifelse</span>(Re <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="fu">log</span>(Re), <span class="cn">NA_real_</span>),</span>
<span id="cb95-14"><a href="#cb95-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">logSt              =</span> <span class="fu">ifelse</span>(St <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="fu">log</span>(St), <span class="cn">NA_real_</span>)</span>
<span id="cb95-15"><a href="#cb95-15" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb95-16"><a href="#cb95-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb95-17"><a href="#cb95-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">Re_x_St        =</span> Re <span class="sc">*</span> St,</span>
<span id="cb95-18"><a href="#cb95-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">invFr_x_Re     =</span> inv_Fr <span class="sc">*</span> Re,</span>
<span id="cb95-19"><a href="#cb95-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">invFr_x_St     =</span> inv_Fr <span class="sc">*</span> St,</span>
<span id="cb95-20"><a href="#cb95-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">logRe_x_logSt  =</span> logRe <span class="sc">*</span> logSt</span>
<span id="cb95-21"><a href="#cb95-21" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb95-22"><a href="#cb95-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(</span>
<span id="cb95-23"><a href="#cb95-23" aria-hidden="true" tabindex="-1"></a>      <span class="co"># base</span></span>
<span id="cb95-24"><a href="#cb95-24" aria-hidden="true" tabindex="-1"></a>      St, Re, inv_Fr,</span>
<span id="cb95-25"><a href="#cb95-25" aria-hidden="true" tabindex="-1"></a>      <span class="co"># scale helpers</span></span>
<span id="cb95-26"><a href="#cb95-26" aria-hidden="true" tabindex="-1"></a>      logRe, logSt,</span>
<span id="cb95-27"><a href="#cb95-27" aria-hidden="true" tabindex="-1"></a>      <span class="co"># light interactions (helps splitting)</span></span>
<span id="cb95-28"><a href="#cb95-28" aria-hidden="true" tabindex="-1"></a>      Re_x_St, invFr_x_Re, invFr_x_St, logRe_x_logSt</span>
<span id="cb95-29"><a href="#cb95-29" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb95-30"><a href="#cb95-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb95-31"><a href="#cb95-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-32"><a href="#cb95-32" aria-hidden="true" tabindex="-1"></a>train_predictors_rf <span class="ot">&lt;-</span> <span class="fu">process_features_rf</span>(train_raw)</span>
<span id="cb95-33"><a href="#cb95-33" aria-hidden="true" tabindex="-1"></a>test_predictors_rf  <span class="ot">&lt;-</span> <span class="fu">process_features_rf</span>(test_raw)</span>
<span id="cb95-34"><a href="#cb95-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-35"><a href="#cb95-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine RF predictors with the *original* log-transformed responses</span></span>
<span id="cb95-36"><a href="#cb95-36" aria-hidden="true" tabindex="-1"></a>train_rf_df <span class="ot">&lt;-</span> <span class="fu">cbind</span>(train_predictors_rf, train_responses_transformed)</span>
<span id="cb95-37"><a href="#cb95-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-38"><a href="#cb95-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the *original* problem_rows to filter the data</span></span>
<span id="cb95-39"><a href="#cb95-39" aria-hidden="true" tabindex="-1"></a>train_model_df <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">length</span>(problem_rows) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb95-40"><a href="#cb95-40" aria-hidden="true" tabindex="-1"></a>  train_rf_df[<span class="sc">-</span>problem_rows, , drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb95-41"><a href="#cb95-41" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb95-42"><a href="#cb95-42" aria-hidden="true" tabindex="-1"></a>  train_rf_df</span>
<span id="cb95-43"><a href="#cb95-43" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb95-44"><a href="#cb95-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-45"><a href="#cb95-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the predictor columns for the RF model (Original 10-feature list)</span></span>
<span id="cb95-46"><a href="#cb95-46" aria-hidden="true" tabindex="-1"></a>x_cols <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"St"</span>,<span class="st">"Re"</span>,<span class="st">"inv_Fr"</span>,</span>
<span id="cb95-47"><a href="#cb95-47" aria-hidden="true" tabindex="-1"></a>            <span class="st">"logRe"</span>,<span class="st">"logSt"</span>,<span class="st">"Re_x_St"</span>,<span class="st">"invFr_x_Re"</span>,<span class="st">"invFr_x_St"</span>,<span class="st">"logRe_x_logSt"</span>)</span>
<span id="cb95-48"><a href="#cb95-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-49"><a href="#cb95-49" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"RF predictors reverted to original 10-feature numeric set.</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>RF predictors reverted to original 10-feature numeric set.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Predictor set:"</span>, <span class="fu">paste</span>(x_cols, <span class="at">collapse =</span> <span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Predictor set: St, Re, inv_Fr, logRe, logSt, Re_x_St, invFr_x_Re, invFr_x_St, logRe_x_logSt </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="do">## ---- random-forest-with-smearing, message=FALSE, warning=FALSE ----------</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Helper function to calculate R-squared</span></span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>calculate_r2 <span class="ot">&lt;-</span> <span class="cf">function</span>(y_true, y_pred) {</span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ensure no NAs in this calculation</span></span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a>  valid_indices <span class="ot">&lt;-</span> <span class="fu">complete.cases</span>(y_true) <span class="sc">&amp;</span> <span class="fu">complete.cases</span>(y_pred)</span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a>  y_true <span class="ot">&lt;-</span> y_true[valid_indices]</span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a>  y_pred <span class="ot">&lt;-</span> y_pred[valid_indices]</span>
<span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb99-11"><a href="#cb99-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(y_true) <span class="sc">&lt;</span> <span class="dv">2</span>) <span class="fu">return</span>(<span class="cn">NA_real_</span>) <span class="co"># Need at least 2 points to calculate variance</span></span>
<span id="cb99-12"><a href="#cb99-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb99-13"><a href="#cb99-13" aria-hidden="true" tabindex="-1"></a>  rss <span class="ot">&lt;-</span> <span class="fu">sum</span>((y_true <span class="sc">-</span> y_pred)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb99-14"><a href="#cb99-14" aria-hidden="true" tabindex="-1"></a>  tss <span class="ot">&lt;-</span> <span class="fu">sum</span>((y_true <span class="sc">-</span> <span class="fu">mean</span>(y_true))<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb99-15"><a href="#cb99-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (tss <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb99-16"><a href="#cb99-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">ifelse</span>(rss <span class="sc">==</span> <span class="dv">0</span>, <span class="fl">1.0</span>, <span class="fl">0.0</span>))</span>
<span id="cb99-17"><a href="#cb99-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb99-18"><a href="#cb99-18" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span> <span class="sc">-</span> (rss <span class="sc">/</span> tss)</span>
<span id="cb99-19"><a href="#cb99-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb99-20"><a href="#cb99-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-21"><a href="#cb99-21" aria-hidden="true" tabindex="-1"></a>targets <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb99-22"><a href="#cb99-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">log_mu    =</span> <span class="fu">list</span>(<span class="at">inv =</span> exp,   <span class="at">smear =</span> <span class="cn">FALSE</span>),</span>
<span id="cb99-23"><a href="#cb99-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">log_sigma =</span> <span class="fu">list</span>(<span class="at">inv =</span> exp,   <span class="at">smear =</span> <span class="cn">TRUE</span>),</span>
<span id="cb99-24"><a href="#cb99-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">log_gamma =</span> <span class="fu">list</span>(<span class="at">inv =</span> exp,   <span class="at">smear =</span> <span class="cn">TRUE</span>),</span>
<span id="cb99-25"><a href="#cb99-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">log_kappa =</span> <span class="fu">list</span>(<span class="at">inv =</span> exp,   <span class="at">smear =</span> <span class="cn">TRUE</span>)</span>
<span id="cb99-26"><a href="#cb99-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb99-27"><a href="#cb99-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-28"><a href="#cb99-28" aria-hidden="true" tabindex="-1"></a>targets[[<span class="st">"gamma"</span>]] <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb99-29"><a href="#cb99-29" aria-hidden="true" tabindex="-1"></a>targets[[<span class="st">"log_gamma"</span>]] <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">inv =</span> exp, <span class="at">smear =</span> <span class="cn">TRUE</span>)</span>
<span id="cb99-30"><a href="#cb99-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-31"><a href="#cb99-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-32"><a href="#cb99-32" aria-hidden="true" tabindex="-1"></a><span class="co"># mtry will now be floor(sqrt(5)) = 2</span></span>
<span id="cb99-33"><a href="#cb99-33" aria-hidden="true" tabindex="-1"></a><span class="co"># min.node.size is set to 5 to reduce overfitting</span></span>
<span id="cb99-34"><a href="#cb99-34" aria-hidden="true" tabindex="-1"></a>rf_args <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb99-35"><a href="#cb99-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">num.trees =</span> 600L,</span>
<span id="cb99-36"><a href="#cb99-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">mtry =</span> <span class="fu">floor</span>(<span class="fu">sqrt</span>(<span class="fu">length</span>(x_cols))), </span>
<span id="cb99-37"><a href="#cb99-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">importance =</span> <span class="st">"permutation"</span>,</span>
<span id="cb99-38"><a href="#cb99-38" aria-hidden="true" tabindex="-1"></a>  <span class="at">min.node.size =</span> 4L,  <span class="co"># &lt;-- Set to 5</span></span>
<span id="cb99-39"><a href="#cb99-39" aria-hidden="true" tabindex="-1"></a>  <span class="at">replace =</span> <span class="cn">TRUE</span>,</span>
<span id="cb99-40"><a href="#cb99-40" aria-hidden="true" tabindex="-1"></a>  <span class="at">sample.fraction =</span> <span class="fl">0.632</span>,</span>
<span id="cb99-41"><a href="#cb99-41" aria-hidden="true" tabindex="-1"></a>  <span class="at">oob.error =</span> <span class="cn">TRUE</span></span>
<span id="cb99-42"><a href="#cb99-42" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb99-43"><a href="#cb99-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-44"><a href="#cb99-44" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">paste</span>(<span class="st">"Running RF with mtry ="</span>, rf_args<span class="sc">$</span>mtry, <span class="st">"and min.node.size ="</span>, rf_args<span class="sc">$</span>min.node.size, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running RF with mtry = 3 and min.node.size = 4 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>models   <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>oob_r2s  <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>in_sample_r2s <span class="ot">&lt;-</span> <span class="fu">c</span>() <span class="co"># To store in-sample R^2</span></span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>smear_sf <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>imps_long <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (tgt <span class="cf">in</span> <span class="fu">names</span>(targets)) {</span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span>tgt <span class="sc">%in%</span> <span class="fu">colnames</span>(train_model_df)) {</span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Skipping target:"</span>, tgt, <span class="st">"(not found in train_model_df)</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">next</span></span>
<span id="cb101-12"><a href="#cb101-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb101-13"><a href="#cb101-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb101-14"><a href="#cb101-14" aria-hidden="true" tabindex="-1"></a>  dat <span class="ot">&lt;-</span> train_model_df[, <span class="fu">c</span>(x_cols, tgt), drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb101-15"><a href="#cb101-15" aria-hidden="true" tabindex="-1"></a>  dat <span class="ot">&lt;-</span> dat[<span class="fu">complete.cases</span>(dat), ]</span>
<span id="cb101-16"><a href="#cb101-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(dat)[<span class="fu">ncol</span>(dat)] <span class="ot">&lt;-</span> <span class="st">"y"</span></span>
<span id="cb101-17"><a href="#cb101-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb101-18"><a href="#cb101-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(dat) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb101-19"><a href="#cb101-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Skipping target:"</span>, tgt, <span class="st">"(no complete cases)</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb101-20"><a href="#cb101-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">next</span></span>
<span id="cb101-21"><a href="#cb101-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb101-22"><a href="#cb101-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-23"><a href="#cb101-23" aria-hidden="true" tabindex="-1"></a>  fit <span class="ot">&lt;-</span> <span class="fu">ranger</span>(</span>
<span id="cb101-24"><a href="#cb101-24" aria-hidden="true" tabindex="-1"></a>    y <span class="sc">~</span> ., <span class="at">data =</span> dat,</span>
<span id="cb101-25"><a href="#cb101-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">num.trees =</span> rf_args<span class="sc">$</span>num.trees,</span>
<span id="cb101-26"><a href="#cb101-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">mtry =</span> rf_args<span class="sc">$</span>mtry,</span>
<span id="cb101-27"><a href="#cb101-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">importance =</span> rf_args<span class="sc">$</span>importance,</span>
<span id="cb101-28"><a href="#cb101-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">min.node.size =</span> rf_args<span class="sc">$</span>min.node.size,</span>
<span id="cb101-29"><a href="#cb101-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">replace =</span> rf_args<span class="sc">$</span>replace,</span>
<span id="cb101-30"><a href="#cb101-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">sample.fraction =</span> rf_args<span class="sc">$</span>sample.fraction,</span>
<span id="cb101-31"><a href="#cb101-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">oob.error =</span> rf_args<span class="sc">$</span>oob.error,</span>
<span id="cb101-32"><a href="#cb101-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> <span class="dv">42</span></span>
<span id="cb101-33"><a href="#cb101-33" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb101-34"><a href="#cb101-34" aria-hidden="true" tabindex="-1"></a>  models[[tgt]] <span class="ot">&lt;-</span> fit</span>
<span id="cb101-35"><a href="#cb101-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb101-36"><a href="#cb101-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># OOB R^2 (from the model object directly)</span></span>
<span id="cb101-37"><a href="#cb101-37" aria-hidden="true" tabindex="-1"></a>  oob_r2s[tgt]  <span class="ot">&lt;-</span> fit<span class="sc">$</span>r.squared</span>
<span id="cb101-38"><a href="#cb101-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb101-39"><a href="#cb101-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># In-sample predictions</span></span>
<span id="cb101-40"><a href="#cb101-40" aria-hidden="true" tabindex="-1"></a>  yhat_in <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit, <span class="at">data =</span> dat[, x_cols, <span class="at">drop =</span> <span class="cn">FALSE</span>])<span class="sc">$</span>predictions</span>
<span id="cb101-41"><a href="#cb101-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb101-42"><a href="#cb101-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># In-sample R^2 (calculated manually)</span></span>
<span id="cb101-43"><a href="#cb101-43" aria-hidden="true" tabindex="-1"></a>  in_sample_r2s[tgt] <span class="ot">&lt;-</span> <span class="fu">calculate_r2</span>(dat<span class="sc">$</span>y, yhat_in)</span>
<span id="cb101-44"><a href="#cb101-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-45"><a href="#cb101-45" aria-hidden="true" tabindex="-1"></a>  resid   <span class="ot">&lt;-</span> dat<span class="sc">$</span>y <span class="sc">-</span> yhat_in <span class="co"># For smearing</span></span>
<span id="cb101-46"><a href="#cb101-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-47"><a href="#cb101-47" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (targets[[tgt]]<span class="sc">$</span>smear) {</span>
<span id="cb101-48"><a href="#cb101-48" aria-hidden="true" tabindex="-1"></a>    smear_sf[tgt] <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">exp</span>(resid), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb101-49"><a href="#cb101-49" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb101-50"><a href="#cb101-50" aria-hidden="true" tabindex="-1"></a>    smear_sf[tgt] <span class="ot">&lt;-</span> <span class="fl">1.0</span></span>
<span id="cb101-51"><a href="#cb101-51" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb101-52"><a href="#cb101-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-53"><a href="#cb101-53" aria-hidden="true" tabindex="-1"></a>  imp <span class="ot">&lt;-</span> <span class="fu">importance</span>(fit)</span>
<span id="cb101-54"><a href="#cb101-54" aria-hidden="true" tabindex="-1"></a>  imps_long[[tgt]] <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">feature =</span> <span class="fu">names</span>(imp),</span>
<span id="cb101-55"><a href="#cb101-55" aria-hidden="true" tabindex="-1"></a>                             <span class="at">importance =</span> <span class="fu">as.numeric</span>(imp),</span>
<span id="cb101-56"><a href="#cb101-56" aria-hidden="true" tabindex="-1"></a>                             <span class="at">target =</span> tgt)</span>
<span id="cb101-57"><a href="#cb101-57" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb101-58"><a href="#cb101-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-59"><a href="#cb101-59" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Load and filter test data predictors ---</span></span>
<span id="cb101-60"><a href="#cb101-60" aria-hidden="true" tabindex="-1"></a>test_data_raw_rf <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data-test.csv"</span>)</span>
<span id="cb101-61"><a href="#cb101-61" aria-hidden="true" tabindex="-1"></a>test_data_valid_predictors_rf <span class="ot">&lt;-</span> test_data_raw_rf <span class="sc">%&gt;%</span></span>
<span id="cb101-62"><a href="#cb101-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(St <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb101-63"><a href="#cb101-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(St, Re, Fr)</span>
<span id="cb101-64"><a href="#cb101-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-65"><a href="#cb101-65" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict test (model scale) -&gt; back-transform</span></span>
<span id="cb101-66"><a href="#cb101-66" aria-hidden="true" tabindex="-1"></a><span class="co"># We must filter the test_predictors_rf in the same way</span></span>
<span id="cb101-67"><a href="#cb101-67" aria-hidden="true" tabindex="-1"></a>valid_test_rows <span class="ot">&lt;-</span> <span class="fu">complete.cases</span>(test_predictors_rf)</span>
<span id="cb101-68"><a href="#cb101-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-69"><a href="#cb101-69" aria-hidden="true" tabindex="-1"></a>pred_model_scale <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(targets), <span class="cf">function</span>(tgt) {</span>
<span id="cb101-70"><a href="#cb101-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(models[[tgt]], <span class="at">data =</span> test_predictors_rf[valid_test_rows, ])<span class="sc">$</span>predictions</span>
<span id="cb101-71"><a href="#cb101-71" aria-hidden="true" tabindex="-1"></a>}) <span class="sc">|&gt;</span> <span class="fu">setNames</span>(<span class="fu">names</span>(targets)) <span class="sc">|&gt;</span> <span class="fu">as_tibble</span>()</span>
<span id="cb101-72"><a href="#cb101-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-73"><a href="#cb101-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-74"><a href="#cb101-74" aria-hidden="true" tabindex="-1"></a>pred_original_scale <span class="ot">&lt;-</span> pred_model_scale <span class="sc">%&gt;%</span></span>
<span id="cb101-75"><a href="#cb101-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb101-76"><a href="#cb101-76" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean      =</span> smear_sf[<span class="st">"log_mu"</span>]    <span class="sc">*</span> targets<span class="sc">$</span>log_mu<span class="sc">$</span><span class="fu">inv</span>(log_mu),</span>
<span id="cb101-77"><a href="#cb101-77" aria-hidden="true" tabindex="-1"></a>    <span class="at">sd        =</span> smear_sf[<span class="st">"log_sigma"</span>] <span class="sc">*</span> targets<span class="sc">$</span>log_sigma<span class="sc">$</span><span class="fu">inv</span>(log_sigma),</span>
<span id="cb101-78"><a href="#cb101-78" aria-hidden="true" tabindex="-1"></a>    <span class="at">skewness  =</span> smear_sf[<span class="st">"log_gamma"</span>] <span class="sc">*</span> targets<span class="sc">$</span>log_gamma<span class="sc">$</span><span class="fu">inv</span>(log_gamma),</span>
<span id="cb101-79"><a href="#cb101-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">kurtosis  =</span> smear_sf[<span class="st">"log_kappa"</span>] <span class="sc">*</span> targets<span class="sc">$</span>log_kappa<span class="sc">$</span><span class="fu">inv</span>(log_kappa)</span>
<span id="cb101-80"><a href="#cb101-80" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb101-81"><a href="#cb101-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(mean, sd, skewness, kurtosis)</span>
<span id="cb101-82"><a href="#cb101-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-83"><a href="#cb101-83" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Bind predictors to predictions ---</span></span>
<span id="cb101-84"><a href="#cb101-84" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">nrow</span>(test_data_valid_predictors_rf) <span class="sc">==</span> <span class="fu">nrow</span>(pred_original_scale)) {</span>
<span id="cb101-85"><a href="#cb101-85" aria-hidden="true" tabindex="-1"></a>  pred_original_scale_with_predictors <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(test_data_valid_predictors_rf, pred_original_scale)</span>
<span id="cb101-86"><a href="#cb101-86" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb101-87"><a href="#cb101-87" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"ERROR: RF predictor and prediction row counts mismatch! Saving predictions only.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb101-88"><a href="#cb101-88" aria-hidden="true" tabindex="-1"></a>  pred_original_scale_with_predictors <span class="ot">&lt;-</span> pred_original_scale <span class="co"># Fallback</span></span>
<span id="cb101-89"><a href="#cb101-89" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb101-90"><a href="#cb101-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-91"><a href="#cb101-91" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(pred_original_scale_with_predictors, <span class="st">"predictions_random_forest_upgraded.csv"</span>)</span>
<span id="cb101-92"><a href="#cb101-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-93"><a href="#cb101-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-94"><a href="#cb101-94" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Importance Tables ---</span></span>
<span id="cb101-95"><a href="#cb101-95" aria-hidden="true" tabindex="-1"></a>imp_long <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(imps_long)</span>
<span id="cb101-96"><a href="#cb101-96" aria-hidden="true" tabindex="-1"></a>imp_avg  <span class="ot">&lt;-</span> imp_long <span class="sc">%&gt;%</span></span>
<span id="cb101-97"><a href="#cb101-97" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(feature) <span class="sc">%&gt;%</span></span>
<span id="cb101-98"><a href="#cb101-98" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">average_importance =</span> <span class="fu">mean</span>(importance, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb101-99"><a href="#cb101-99" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(average_importance))</span>
<span id="cb101-100"><a href="#cb101-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-101"><a href="#cb101-101" aria-hidden="true" tabindex="-1"></a>imp_wide <span class="ot">&lt;-</span> imp_long <span class="sc">%&gt;%</span></span>
<span id="cb101-102"><a href="#cb101-102" aria-hidden="true" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_wider</span>(<span class="at">names_from =</span> target, <span class="at">values_from =</span> importance) <span class="sc">%&gt;%</span></span>
<span id="cb101-103"><a href="#cb101-103" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(imp_avg, <span class="at">by =</span> <span class="st">"feature"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb101-104"><a href="#cb101-104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(average_importance))</span>
<span id="cb101-105"><a href="#cb101-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-106"><a href="#cb101-106" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(imp_wide, <span class="st">"random_forest_feature_importances_upgraded.csv"</span>)</span>
<span id="cb101-107"><a href="#cb101-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-108"><a href="#cb101-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-109"><a href="#cb101-109" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Print both R^2 values for comparison ---</span></span>
<span id="cb101-110"><a href="#cb101-110" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Model Performance Comparison ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Model Performance Comparison ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">In-Sample R^2 (Performance on training data):</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
In-Sample R^2 (Performance on training data):</code></pre>
</div>
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">round</span>(in_sample_r2s, <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   log_mu log_sigma log_gamma log_kappa 
    0.997     0.979     0.981     0.984 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">OOB R^2 (Estimated performance on new data):</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
OOB R^2 (Estimated performance on new data):</code></pre>
</div>
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">round</span>(oob_r2s, <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   log_mu log_sigma log_gamma log_kappa 
    0.992     0.942     0.948     0.955 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">(The gap between In-Sample and OOB R^2 is the amount of overfitting.)</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
(The gap between In-Sample and OOB R^2 is the amount of overfitting.)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Smearing factors (log targets only):</span><span class="sc">\n</span><span class="st">"</span>); <span class="fu">print</span>(<span class="fu">round</span>(smear_sf[smear_sf <span class="sc">!=</span> <span class="dv">1</span>], <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Smearing factors (log targets only):</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>log_sigma log_gamma log_kappa 
    1.050     1.015     1.047 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Wrote:</span><span class="sc">\n</span><span class="st"> - predictions_random_forest_upgraded.csv (now with predictors)</span><span class="sc">\n</span><span class="st"> - random_forest_feature_importances_upgraded.csv</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Wrote:
 - predictions_random_forest_upgraded.csv (now with predictors)
 - random_forest_feature_importances_upgraded.csv</code></pre>
</div>
</div>
<p>Some overfitting but not a lot</p>
</section>
</section>
<section id="comparing-model-predictions" class="level1">
<h1>Comparing model predictions</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load libraries for plotting and data manipulation</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 1. Load Prediction Data ---</span></span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a>gam_preds <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"predictions_gam_hybrid.csv"</span>)</span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a>rf_preds <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"predictions_random_forest_upgraded.csv"</span>)</span>
<span id="cb118-10"><a href="#cb118-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb118-11"><a href="#cb118-11" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 2. Prepare Data for Plotting ---</span></span>
<span id="cb118-12"><a href="#cb118-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb118-13"><a href="#cb118-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Select predictors from one file and make them factors</span></span>
<span id="cb118-14"><a href="#cb118-14" aria-hidden="true" tabindex="-1"></a>predictors <span class="ot">&lt;-</span> gam_preds <span class="sc">%&gt;%</span></span>
<span id="cb118-15"><a href="#cb118-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(St, Re, Fr) <span class="sc">%&gt;%</span></span>
<span id="cb118-16"><a href="#cb118-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb118-17"><a href="#cb118-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">Re_factor =</span> <span class="fu">factor</span>(Re),</span>
<span id="cb118-18"><a href="#cb118-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">Fr_factor =</span> <span class="fu">factor</span>(Fr) <span class="co"># 'Fr' is better as a factor for plotting</span></span>
<span id="cb118-19"><a href="#cb118-19" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb118-20"><a href="#cb118-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-21"><a href="#cb118-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Select and rename GAM predictions</span></span>
<span id="cb118-22"><a href="#cb118-22" aria-hidden="true" tabindex="-1"></a>gam_preds_only <span class="ot">&lt;-</span> gam_preds <span class="sc">%&gt;%</span></span>
<span id="cb118-23"><a href="#cb118-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(mean, sd, skewness, kurtosis) <span class="sc">%&gt;%</span></span>
<span id="cb118-24"><a href="#cb118-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename_with</span>(<span class="sc">~</span> <span class="fu">paste0</span>(., <span class="st">"_gam"</span>), <span class="fu">everything</span>())</span>
<span id="cb118-25"><a href="#cb118-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb118-26"><a href="#cb118-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Select and rename RF predictions</span></span>
<span id="cb118-27"><a href="#cb118-27" aria-hidden="true" tabindex="-1"></a>rf_preds_only <span class="ot">&lt;-</span> rf_preds <span class="sc">%&gt;%</span></span>
<span id="cb118-28"><a href="#cb118-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(mean, sd, skewness, kurtosis) <span class="sc">%&gt;%</span></span>
<span id="cb118-29"><a href="#cb118-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename_with</span>(<span class="sc">~</span> <span class="fu">paste0</span>(., <span class="st">"_rf"</span>), <span class="fu">everything</span>())</span>
<span id="cb118-30"><a href="#cb118-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb118-31"><a href="#cb118-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Bind them all together</span></span>
<span id="cb118-32"><a href="#cb118-32" aria-hidden="true" tabindex="-1"></a>combined_preds <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(predictors, gam_preds_only, rf_preds_only)</span>
<span id="cb118-33"><a href="#cb118-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-34"><a href="#cb118-34" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 3. Create Individual Scatter Plots ---</span></span>
<span id="cb118-35"><a href="#cb118-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb118-36"><a href="#cb118-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Helper to find plot limits to ensure the y=x line is visible</span></span>
<span id="cb118-37"><a href="#cb118-37" aria-hidden="true" tabindex="-1"></a>  get_limits <span class="ot">&lt;-</span> <span class="cf">function</span>(a, b) {</span>
<span id="cb118-38"><a href="#cb118-38" aria-hidden="true" tabindex="-1"></a>    all_vals <span class="ot">&lt;-</span> <span class="fu">c</span>(a, b)</span>
<span id="cb118-39"><a href="#cb118-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">range</span>(all_vals, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb118-40"><a href="#cb118-40" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb118-41"><a href="#cb118-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-42"><a href="#cb118-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot 1: Mean (mu)</span></span>
<span id="cb118-43"><a href="#cb118-43" aria-hidden="true" tabindex="-1"></a>  mean_limits <span class="ot">&lt;-</span> <span class="fu">get_limits</span>(combined_preds<span class="sc">$</span>mean_gam, combined_preds<span class="sc">$</span>mean_rf)</span>
<span id="cb118-44"><a href="#cb118-44" aria-hidden="true" tabindex="-1"></a>  p_mean <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(combined_preds, <span class="fu">aes</span>(<span class="at">x =</span> mean_gam, <span class="at">y =</span> mean_rf, <span class="at">color =</span> Re_factor)) <span class="sc">+</span></span>
<span id="cb118-45"><a href="#cb118-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.8</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb118-46"><a href="#cb118-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb118-47"><a href="#cb118-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Mean (mu) Agreement"</span>, </span>
<span id="cb118-48"><a href="#cb118-48" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"GAM Prediction"</span>, <span class="at">y =</span> <span class="st">"RF Prediction"</span>,</span>
<span id="cb118-49"><a href="#cb118-49" aria-hidden="true" tabindex="-1"></a>         <span class="at">color =</span> <span class="st">"Re Factor"</span>) <span class="sc">+</span></span>
<span id="cb118-50"><a href="#cb118-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlim</span>(mean_limits) <span class="sc">+</span> <span class="fu">ylim</span>(mean_limits) <span class="sc">+</span></span>
<span id="cb118-51"><a href="#cb118-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()</span>
<span id="cb118-52"><a href="#cb118-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-53"><a href="#cb118-53" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot 2: Standard Deviation (sd)</span></span>
<span id="cb118-54"><a href="#cb118-54" aria-hidden="true" tabindex="-1"></a>  sd_limits <span class="ot">&lt;-</span> <span class="fu">get_limits</span>(combined_preds<span class="sc">$</span>sd_gam, combined_preds<span class="sc">$</span>sd_rf)</span>
<span id="cb118-55"><a href="#cb118-55" aria-hidden="true" tabindex="-1"></a>  p_sd <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(combined_preds, <span class="fu">aes</span>(<span class="at">x =</span> sd_gam, <span class="at">y =</span> sd_rf, <span class="at">color =</span> Re_factor)) <span class="sc">+</span></span>
<span id="cb118-56"><a href="#cb118-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.8</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb118-57"><a href="#cb118-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb118-58"><a href="#cb118-58" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Standard Deviation (sigma) Agreement"</span>, </span>
<span id="cb118-59"><a href="#cb118-59" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"GAM Prediction"</span>, <span class="at">y =</span> <span class="st">"RF Prediction"</span>,</span>
<span id="cb118-60"><a href="#cb118-60" aria-hidden="true" tabindex="-1"></a>         <span class="at">color =</span> <span class="st">"Re Factor"</span>) <span class="sc">+</span></span>
<span id="cb118-61"><a href="#cb118-61" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlim</span>(sd_limits) <span class="sc">+</span> <span class="fu">ylim</span>(sd_limits) <span class="sc">+</span></span>
<span id="cb118-62"><a href="#cb118-62" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()</span>
<span id="cb118-63"><a href="#cb118-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-64"><a href="#cb118-64" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot 3: Skewness (gamma)</span></span>
<span id="cb118-65"><a href="#cb118-65" aria-hidden="true" tabindex="-1"></a>  skew_limits <span class="ot">&lt;-</span> <span class="fu">get_limits</span>(combined_preds<span class="sc">$</span>skewness_gam, combined_preds<span class="sc">$</span>skewness_rf)</span>
<span id="cb118-66"><a href="#cb118-66" aria-hidden="true" tabindex="-1"></a>  p_skew <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(combined_preds, <span class="fu">aes</span>(<span class="at">x =</span> skewness_gam, <span class="at">y =</span> skewness_rf, <span class="at">color =</span> Re_factor)) <span class="sc">+</span></span>
<span id="cb118-67"><a href="#cb118-67" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.8</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb118-68"><a href="#cb118-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb118-69"><a href="#cb118-69" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Skewness (gamma) Agreement"</span>, </span>
<span id="cb118-70"><a href="#cb118-70" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"GAM Prediction"</span>, <span class="at">y =</span> <span class="st">"RF Prediction"</span>,</span>
<span id="cb118-71"><a href="#cb118-71" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"Re Factor"</span>) <span class="sc">+</span></span>
<span id="cb118-72"><a href="#cb118-72" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlim</span>(skew_limits) <span class="sc">+</span> <span class="fu">ylim</span>(skew_limits) <span class="sc">+</span></span>
<span id="cb118-73"><a href="#cb118-73" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()</span>
<span id="cb118-74"><a href="#cb118-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-75"><a href="#cb118-75" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot 4: Kurtosis (kappa)</span></span>
<span id="cb118-76"><a href="#cb118-76" aria-hidden="true" tabindex="-1"></a>  kurt_limits <span class="ot">&lt;-</span> <span class="fu">get_limits</span>(combined_preds<span class="sc">$</span>kurtosis_gam, combined_preds<span class="sc">$</span>kurtosis_rf)</span>
<span id="cb118-77"><a href="#cb118-77" aria-hidden="true" tabindex="-1"></a>  p_kurt <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(combined_preds, <span class="fu">aes</span>(<span class="at">x =</span> kurtosis_gam, <span class="at">y =</span> kurtosis_rf, <span class="at">color =</span> Re_factor)) <span class="sc">+</span></span>
<span id="cb118-78"><a href="#cb118-78" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.8</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb118-79"><a href="#cb118-79" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb118-80"><a href="#cb118-80" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Kurtosis (kappa) Agreement"</span>, </span>
<span id="cb118-81"><a href="#cb118-81" aria-hidden="true" tabindex="-1"></a>          <span class="at">x =</span> <span class="st">"GAM Prediction"</span>, <span class="at">y =</span> <span class="st">"RF Prediction"</span>,</span>
<span id="cb118-82"><a href="#cb118-82" aria-hidden="true" tabindex="-1"></a>          <span class="at">color =</span> <span class="st">"Re Factor"</span>) <span class="sc">+</span></span>
<span id="cb118-83"><a href="#cb118-83" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlim</span>(kurt_limits) <span class="sc">+</span> <span class="fu">ylim</span>(kurt_limits) <span class="sc">+</span></span>
<span id="cb118-84"><a href="#cb118-84" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()</span>
<span id="cb118-85"><a href="#cb118-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-86"><a href="#cb118-86" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- 4. Combine and Display Plots ---</span></span>
<span id="cb118-87"><a href="#cb118-87" aria-hidden="true" tabindex="-1"></a>  (p_mean <span class="sc">+</span> p_sd) <span class="sc">/</span> (p_skew <span class="sc">+</span> p_kurt) <span class="sc">+</span></span>
<span id="cb118-88"><a href="#cb118-88" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot_annotation</span>(</span>
<span id="cb118-89"><a href="#cb118-89" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Model Comparison: GAM vs. Random Forest Predictions"</span>,</span>
<span id="cb118-90"><a href="#cb118-90" aria-hidden="true" tabindex="-1"></a>      <span class="at">subtitle =</span> <span class="st">"Points colored by Reynolds Number (Re)"</span>,</span>
<span id="cb118-91"><a href="#cb118-91" aria-hidden="true" tabindex="-1"></a>      <span class="at">theme =</span> <span class="fu">theme</span>(</span>
<span id="cb118-92"><a href="#cb118-92" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>, <span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb118-93"><a href="#cb118-93" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>)</span>
<span id="cb118-94"><a href="#cb118-94" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb118-95"><a href="#cb118-95" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Case-Study_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" width="960"></p>
</div>
</div>
<ol type="1">
<li>Overall Model Agreement is Excellent</li>
</ol>
<p>The most important takeaway is that your two very different modeling approaches (a semi-parametric GAM and a non-parametric Random Forest) produced highly consistent results. This is fantastic news. It strongly suggests that our relationships that we have’ve modeled are real, robust features of the data, not just an artifact of one specific algorithm. When different methods converge on the same answer, it builds significant trust in the results.</p>
<ol start="2" type="1">
<li>Detailed Breakdown by Variable</li>
</ol>
<ol type="a">
<li><p>Mean (mu): The points form three distinct diagonal clusters, each corresponding to one of the Reynolds numbers (Re_factor). The fact that all three clusters are so tight and fall directly on the red “Agreement (y=x)” line is a fantastic result. It visually confirms that the GAM model (log_mu ~ Re_factor + s(log_St_s)) is capturing the same complex relationships as the Random Forest, and both models are in complete consensus about the data’s underlying patterns. There was no need to overcomplicate GAM.</p></li>
<li><p>Standard Deviation (sigma): The agreement is near-perfect. For Standard Deviation (sigma), the points fall almost exactly on the red dashed line. This “y=x” line represents perfect agreement. This tells you that both models learned the exact same, strong patterns for predicting the standard deviation.</p></li>
<li><p>Skewness (gamma) &amp; Kurtosis (kappa): For these higher-order moments, the agreement is still very good, but you can see more scatter. The points still follow the red line (low predictions from one model match low from the other), but with more variance. This is completely expected. These properties are inherently more “noisy” and difficult to model.</p></li>
<li><p>The Main Point of Divergence: Kurtosis: The Kurtosis (kappa) plot shows the most disagreement. While the models agree on the trend, the points are more scattered. The statistical analysis of the difference between the models (GAM - RF) confirms this. The GAM model systematically predicts slightly higher kurtosis values than the Random Forest. This isn’t a sign that one model is “wrong,” but rather that they have different ways of interpreting the complex interactions that lead to extreme kurtosis values. This is a valuable insight, as it isolates the single most complex metric that is hardest to predict.</p></li>
</ol>
<p>In addition, needed to be mentioned is that as we can see for Re factor of 398 the models seem to have different opinions and disagree the most. This could be because we have the least amount of data for Re factor 398.</p>
<section id="displaying-predictions" class="level2">
<h2 class="anchored" data-anchor-id="displaying-predictions">Displaying predictions</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The prediction files now contain the predictors</span></span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>gam_table <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"predictions_gam_hybrid.csv"</span>)</span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>rf_table <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"predictions_random_forest_upgraded.csv"</span>)</span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 2. Create GAM Table ---</span></span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"--- GAM Predictions with Test Data Predictors ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- GAM Predictions with Test Data Predictors ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(gam_table, <span class="at">format =</span> <span class="st">"pipe"</span>, <span class="at">digits =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">St</th>
<th style="text-align: right;">Re</th>
<th style="text-align: right;">Fr</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">sd</th>
<th style="text-align: right;">skewness</th>
<th style="text-align: right;">kurtosis</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0.05</td>
<td style="text-align: right;">398</td>
<td style="text-align: right;">0.052</td>
<td style="text-align: right;">0.0002</td>
<td style="text-align: right;">0.0077</td>
<td style="text-align: right;">227.2514</td>
<td style="text-align: right;">69300.9737</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.20</td>
<td style="text-align: right;">398</td>
<td style="text-align: right;">0.052</td>
<td style="text-align: right;">0.0003</td>
<td style="text-align: right;">0.0612</td>
<td style="text-align: right;">301.4068</td>
<td style="text-align: right;">93098.7890</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.70</td>
<td style="text-align: right;">398</td>
<td style="text-align: right;">0.052</td>
<td style="text-align: right;">0.0003</td>
<td style="text-align: right;">0.0713</td>
<td style="text-align: right;">280.5516</td>
<td style="text-align: right;">78356.4672</td>
</tr>
<tr class="even">
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">398</td>
<td style="text-align: right;">0.052</td>
<td style="text-align: right;">0.0004</td>
<td style="text-align: right;">0.0772</td>
<td style="text-align: right;">267.4168</td>
<td style="text-align: right;">70967.4904</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.10</td>
<td style="text-align: right;">398</td>
<td style="text-align: right;">Inf</td>
<td style="text-align: right;">0.0003</td>
<td style="text-align: right;">0.0504</td>
<td style="text-align: right;">268.0631</td>
<td style="text-align: right;">79196.9111</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.60</td>
<td style="text-align: right;">398</td>
<td style="text-align: right;">Inf</td>
<td style="text-align: right;">0.0003</td>
<td style="text-align: right;">0.0955</td>
<td style="text-align: right;">278.0537</td>
<td style="text-align: right;">75360.7003</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">398</td>
<td style="text-align: right;">Inf</td>
<td style="text-align: right;">0.0004</td>
<td style="text-align: right;">0.1056</td>
<td style="text-align: right;">260.2215</td>
<td style="text-align: right;">65705.6273</td>
</tr>
<tr class="even">
<td style="text-align: right;">1.50</td>
<td style="text-align: right;">398</td>
<td style="text-align: right;">Inf</td>
<td style="text-align: right;">0.0004</td>
<td style="text-align: right;">0.1198</td>
<td style="text-align: right;">245.2039</td>
<td style="text-align: right;">58113.0638</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3.00</td>
<td style="text-align: right;">398</td>
<td style="text-align: right;">Inf</td>
<td style="text-align: right;">0.0005</td>
<td style="text-align: right;">0.1409</td>
<td style="text-align: right;">215.3053</td>
<td style="text-align: right;">46236.1271</td>
</tr>
<tr class="even">
<td style="text-align: right;">3.00</td>
<td style="text-align: right;">224</td>
<td style="text-align: right;">0.300</td>
<td style="text-align: right;">0.0043</td>
<td style="text-align: right;">0.2894</td>
<td style="text-align: right;">73.0709</td>
<td style="text-align: right;">5541.9915</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.10</td>
<td style="text-align: right;">224</td>
<td style="text-align: right;">Inf</td>
<td style="text-align: right;">0.0021</td>
<td style="text-align: right;">0.1125</td>
<td style="text-align: right;">88.6298</td>
<td style="text-align: right;">9035.8864</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.50</td>
<td style="text-align: right;">224</td>
<td style="text-align: right;">Inf</td>
<td style="text-align: right;">0.0027</td>
<td style="text-align: right;">0.2095</td>
<td style="text-align: right;">93.6977</td>
<td style="text-align: right;">8948.7186</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.40</td>
<td style="text-align: right;">90</td>
<td style="text-align: right;">0.052</td>
<td style="text-align: right;">0.1010</td>
<td style="text-align: right;">22.9812</td>
<td style="text-align: right;">289.5666</td>
<td style="text-align: right;">85551.2792</td>
</tr>
<tr class="even">
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">90</td>
<td style="text-align: right;">0.052</td>
<td style="text-align: right;">0.1171</td>
<td style="text-align: right;">26.3883</td>
<td style="text-align: right;">260.8604</td>
<td style="text-align: right;">68819.8851</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.05</td>
<td style="text-align: right;">90</td>
<td style="text-align: right;">0.300</td>
<td style="text-align: right;">0.0665</td>
<td style="text-align: right;">0.0925</td>
<td style="text-align: right;">12.5664</td>
<td style="text-align: right;">236.2098</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.30</td>
<td style="text-align: right;">90</td>
<td style="text-align: right;">0.300</td>
<td style="text-align: right;">0.0980</td>
<td style="text-align: right;">0.7794</td>
<td style="text-align: right;">16.6835</td>
<td style="text-align: right;">312.0179</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.60</td>
<td style="text-align: right;">90</td>
<td style="text-align: right;">0.300</td>
<td style="text-align: right;">0.1061</td>
<td style="text-align: right;">0.8358</td>
<td style="text-align: right;">15.8007</td>
<td style="text-align: right;">277.4345</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.80</td>
<td style="text-align: right;">90</td>
<td style="text-align: right;">0.300</td>
<td style="text-align: right;">0.1114</td>
<td style="text-align: right;">0.8732</td>
<td style="text-align: right;">15.2475</td>
<td style="text-align: right;">257.7281</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.40</td>
<td style="text-align: right;">90</td>
<td style="text-align: right;">Inf</td>
<td style="text-align: right;">0.1010</td>
<td style="text-align: right;">0.8670</td>
<td style="text-align: right;">17.8943</td>
<td style="text-align: right;">351.8253</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.50</td>
<td style="text-align: right;">90</td>
<td style="text-align: right;">Inf</td>
<td style="text-align: right;">0.1036</td>
<td style="text-align: right;">0.8853</td>
<td style="text-align: right;">17.5557</td>
<td style="text-align: right;">337.8394</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.60</td>
<td style="text-align: right;">90</td>
<td style="text-align: right;">Inf</td>
<td style="text-align: right;">0.1061</td>
<td style="text-align: right;">0.9010</td>
<td style="text-align: right;">17.2251</td>
<td style="text-align: right;">324.6062</td>
</tr>
<tr class="even">
<td style="text-align: right;">1.50</td>
<td style="text-align: right;">90</td>
<td style="text-align: right;">Inf</td>
<td style="text-align: right;">0.1314</td>
<td style="text-align: right;">1.1297</td>
<td style="text-align: right;">15.1901</td>
<td style="text-align: right;">250.3143</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2.00</td>
<td style="text-align: right;">90</td>
<td style="text-align: right;">Inf</td>
<td style="text-align: right;">0.1436</td>
<td style="text-align: right;">1.2216</td>
<td style="text-align: right;">14.4650</td>
<td style="text-align: right;">228.2620</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 3. Create RF Table ---</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">--- Random Forest Predictions with Test Data Predictors ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>

--- Random Forest Predictions with Test Data Predictors ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(rf_table, <span class="at">format =</span> <span class="st">"pipe"</span>, <span class="at">digits =</span> <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">St</th>
<th style="text-align: right;">Re</th>
<th style="text-align: right;">Fr</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">sd</th>
<th style="text-align: right;">skewness</th>
<th style="text-align: right;">kurtosis</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0.05</td>
<td style="text-align: right;">398</td>
<td style="text-align: right;">0.052</td>
<td style="text-align: right;">0.0003</td>
<td style="text-align: right;">0.0425</td>
<td style="text-align: right;">239.0629</td>
<td style="text-align: right;">68539.8169</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.20</td>
<td style="text-align: right;">398</td>
<td style="text-align: right;">0.052</td>
<td style="text-align: right;">0.0004</td>
<td style="text-align: right;">0.0875</td>
<td style="text-align: right;">292.0257</td>
<td style="text-align: right;">88024.7013</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.70</td>
<td style="text-align: right;">398</td>
<td style="text-align: right;">0.052</td>
<td style="text-align: right;">0.0003</td>
<td style="text-align: right;">0.0807</td>
<td style="text-align: right;">266.1182</td>
<td style="text-align: right;">72143.9342</td>
</tr>
<tr class="even">
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">398</td>
<td style="text-align: right;">0.052</td>
<td style="text-align: right;">0.0004</td>
<td style="text-align: right;">0.0859</td>
<td style="text-align: right;">250.5590</td>
<td style="text-align: right;">63878.7939</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.10</td>
<td style="text-align: right;">398</td>
<td style="text-align: right;">Inf</td>
<td style="text-align: right;">0.0004</td>
<td style="text-align: right;">0.0626</td>
<td style="text-align: right;">217.5497</td>
<td style="text-align: right;">52140.5975</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.60</td>
<td style="text-align: right;">398</td>
<td style="text-align: right;">Inf</td>
<td style="text-align: right;">0.0004</td>
<td style="text-align: right;">0.0860</td>
<td style="text-align: right;">243.8515</td>
<td style="text-align: right;">59712.1493</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">398</td>
<td style="text-align: right;">Inf</td>
<td style="text-align: right;">0.0006</td>
<td style="text-align: right;">0.0952</td>
<td style="text-align: right;">200.0450</td>
<td style="text-align: right;">40828.1093</td>
</tr>
<tr class="even">
<td style="text-align: right;">1.50</td>
<td style="text-align: right;">398</td>
<td style="text-align: right;">Inf</td>
<td style="text-align: right;">0.0006</td>
<td style="text-align: right;">0.1040</td>
<td style="text-align: right;">183.4028</td>
<td style="text-align: right;">33841.4633</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3.00</td>
<td style="text-align: right;">398</td>
<td style="text-align: right;">Inf</td>
<td style="text-align: right;">0.0007</td>
<td style="text-align: right;">0.1160</td>
<td style="text-align: right;">162.3684</td>
<td style="text-align: right;">26787.4731</td>
</tr>
<tr class="even">
<td style="text-align: right;">3.00</td>
<td style="text-align: right;">224</td>
<td style="text-align: right;">0.300</td>
<td style="text-align: right;">0.0043</td>
<td style="text-align: right;">0.3676</td>
<td style="text-align: right;">78.1239</td>
<td style="text-align: right;">5953.3638</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.10</td>
<td style="text-align: right;">224</td>
<td style="text-align: right;">Inf</td>
<td style="text-align: right;">0.0020</td>
<td style="text-align: right;">0.1354</td>
<td style="text-align: right;">87.8730</td>
<td style="text-align: right;">9015.0370</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.50</td>
<td style="text-align: right;">224</td>
<td style="text-align: right;">Inf</td>
<td style="text-align: right;">0.0027</td>
<td style="text-align: right;">0.2178</td>
<td style="text-align: right;">97.1461</td>
<td style="text-align: right;">9650.0704</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.40</td>
<td style="text-align: right;">90</td>
<td style="text-align: right;">0.052</td>
<td style="text-align: right;">0.1110</td>
<td style="text-align: right;">15.8141</td>
<td style="text-align: right;">265.7822</td>
<td style="text-align: right;">72181.6679</td>
</tr>
<tr class="even">
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">90</td>
<td style="text-align: right;">0.052</td>
<td style="text-align: right;">0.1222</td>
<td style="text-align: right;">24.1672</td>
<td style="text-align: right;">267.6005</td>
<td style="text-align: right;">71780.6148</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.05</td>
<td style="text-align: right;">90</td>
<td style="text-align: right;">0.300</td>
<td style="text-align: right;">0.0665</td>
<td style="text-align: right;">0.3376</td>
<td style="text-align: right;">19.4352</td>
<td style="text-align: right;">491.2114</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.30</td>
<td style="text-align: right;">90</td>
<td style="text-align: right;">0.300</td>
<td style="text-align: right;">0.0803</td>
<td style="text-align: right;">0.6243</td>
<td style="text-align: right;">17.7340</td>
<td style="text-align: right;">385.4342</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.60</td>
<td style="text-align: right;">90</td>
<td style="text-align: right;">0.300</td>
<td style="text-align: right;">0.0954</td>
<td style="text-align: right;">0.9529</td>
<td style="text-align: right;">17.8668</td>
<td style="text-align: right;">378.2724</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.80</td>
<td style="text-align: right;">90</td>
<td style="text-align: right;">0.300</td>
<td style="text-align: right;">0.0997</td>
<td style="text-align: right;">0.9835</td>
<td style="text-align: right;">16.8093</td>
<td style="text-align: right;">318.3262</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.40</td>
<td style="text-align: right;">90</td>
<td style="text-align: right;">Inf</td>
<td style="text-align: right;">0.0775</td>
<td style="text-align: right;">0.6635</td>
<td style="text-align: right;">18.4191</td>
<td style="text-align: right;">420.1099</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.50</td>
<td style="text-align: right;">90</td>
<td style="text-align: right;">Inf</td>
<td style="text-align: right;">0.0831</td>
<td style="text-align: right;">0.7384</td>
<td style="text-align: right;">18.1989</td>
<td style="text-align: right;">400.2552</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.60</td>
<td style="text-align: right;">90</td>
<td style="text-align: right;">Inf</td>
<td style="text-align: right;">0.0883</td>
<td style="text-align: right;">0.8225</td>
<td style="text-align: right;">17.6563</td>
<td style="text-align: right;">367.7810</td>
</tr>
<tr class="even">
<td style="text-align: right;">1.50</td>
<td style="text-align: right;">90</td>
<td style="text-align: right;">Inf</td>
<td style="text-align: right;">0.1031</td>
<td style="text-align: right;">1.0562</td>
<td style="text-align: right;">16.1530</td>
<td style="text-align: right;">273.1885</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2.00</td>
<td style="text-align: right;">90</td>
<td style="text-align: right;">Inf</td>
<td style="text-align: right;">0.1128</td>
<td style="text-align: right;">1.1776</td>
<td style="text-align: right;">15.9024</td>
<td style="text-align: right;">265.9544</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>In this analysis, we applied a consistent Duan smearing factor to correct for re-transformation bias in both the Random Forest and the hybrid GAM predictions. Since our models were trained to predict log-transformed targets (like log_sigma, log_gamma, and log_kappa), simply exponentiating the final prediction would result in a systematically biased, low estimate. To correct this, we first calculated the residuals for each model on the log scale (e.g., log_sigma_actual - log_sigma_predicted) using the training data. We then computed a specific smearing factor for each target by taking the mean(exp(residuals)). This factor was then multiplied against the exponentiated test-set predictions (e.g., sd = smear_sigma * exp(log_sigma_pred)) to produce a final, unbiased prediction on the original scale, while log_mu was left un-smeared as a justified modeling choice.</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>